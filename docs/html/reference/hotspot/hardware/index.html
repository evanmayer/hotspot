
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.4">
    
    
      
        <title>Hardware - hotspot</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.80dcb947.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-hotspothardware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="hotspot" class="md-header__button md-logo" aria-label="hotspot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            hotspot
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hardware
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/evanmayer/hotspot" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotspot
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="hotspot" class="md-nav__button md-logo" aria-label="hotspot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    hotspot
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/evanmayer/hotspot" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotspot
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../HOWTO/" class="md-nav__link">
        Howto
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Hotspot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hotspot" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Hotspot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../algorithm/" class="md-nav__link">
        Algorithm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        Constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../executive/" class="md-nav__link">
        Executive
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Hardware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Hardware
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all_steppers_ez" class="md-nav__link">
    all_steppers_ez
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bump_hard_stop" class="md-nav__link">
    bump_hard_stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_ready" class="md-nav__link">
    ezstepper_check_ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_status" class="md-nav__link">
    ezstepper_check_status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_write" class="md-nav__link">
    ezstepper_write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_encoder_pos" class="md-nav__link">
    get_encoder_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look_for_response" class="md-nav__link">
    look_for_response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_hawkeye_byte" class="md-nav__link">
    send_hawkeye_byte
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wait_for_ready" class="md-nav__link">
    wait_for_ready
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#commandbuffer" class="md-nav__link">
    CommandBuffer
  </a>
  
    <nav class="md-nav" aria-label="CommandBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#empty" class="md-nav__link">
    empty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    get
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#put" class="md-nav__link">
    put
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terminate" class="md-nav__link">
    terminate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hw_context/" class="md-nav__link">
        Hw Context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../telemetry/" class="md-nav__link">
        Telemetry
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all_steppers_ez" class="md-nav__link">
    all_steppers_ez
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bump_hard_stop" class="md-nav__link">
    bump_hard_stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_ready" class="md-nav__link">
    ezstepper_check_ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_status" class="md-nav__link">
    ezstepper_check_status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_write" class="md-nav__link">
    ezstepper_write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_encoder_pos" class="md-nav__link">
    get_encoder_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look_for_response" class="md-nav__link">
    look_for_response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_hawkeye_byte" class="md-nav__link">
    send_hawkeye_byte
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wait_for_ready" class="md-nav__link">
    wait_for_ready
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#commandbuffer" class="md-nav__link">
    CommandBuffer
  </a>
  
    <nav class="md-nav" aria-label="CommandBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#empty" class="md-nav__link">
    empty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    get
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#put" class="md-nav__link">
    put
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terminate" class="md-nav__link">
    terminate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/evanmayer/hotspot/edit/main/reference/hotspot/hardware.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="module-hotspothardware">Module hotspot.hardware</h1>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">#</span> <span class="nv">This</span> <span class="s s-Atom">file</span> <span class="s s-Atom">defines</span> <span class="s s-Atom">the</span> <span class="s s-Atom">interfaces</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">command</span> <span class="s s-Atom">the</span> <span class="s s-Atom">hardware</span><span class="p">.</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">logging</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">numpy</span> <span class="s s-Atom">as</span> <span class="s s-Atom">np</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">sys</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">time</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">hotspot</span><span class="p">.</span><span class="s s-Atom">constants</span> <span class="s s-Atom">as</span> <span class="s s-Atom">const</span>

<span class="s s-Atom">from</span> <span class="s s-Atom">hotspot</span><span class="p">.</span><span class="s s-Atom">hw_context</span> <span class="s s-Atom">import</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="nv">HawkeyeSerial</span>

<span class="s s-Atom">logger</span> <span class="o">=</span> <span class="s s-Atom">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="k">__</span><span class="s s-Atom">name__</span><span class="p">)</span>

<span class="nv">IDX_READY_BIT</span> <span class="o">=</span> <span class="mi">2</span>

<span class="nv">IDX_STATUS_BYTE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="nv">NUM_TRAILING_BYTES</span> <span class="o">=</span> <span class="mi">3</span>

<span class="s s-Atom">#</span> <span class="nv">Conventions</span><span class="o">:</span>

<span class="s s-Atom">#</span> <span class="o">-</span> <span class="s s-Atom">positive</span> <span class="s s-Atom">steps</span><span class="o">/</span><span class="s s-Atom">angular</span> <span class="s s-Atom">rates</span> <span class="s s-Atom">spin</span> <span class="s s-Atom">the</span> <span class="s s-Atom">motor</span> <span class="s s-Atom">shaft</span> <span class="nf">clockwise</span> <span class="p">(</span><span class="nv">CW</span><span class="p">)</span> <span class="s s-Atom">when</span>

<span class="s s-Atom">#</span>   <span class="s s-Atom">viewed</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="s s-Atom">rear</span><span class="p">.</span>

<span class="s s-Atom">#</span> <span class="o">-</span> <span class="s s-Atom">negative</span> <span class="s s-Atom">steps</span><span class="o">/</span><span class="s s-Atom">angular</span> <span class="s s-Atom">rates</span> <span class="s s-Atom">spin</span> <span class="s s-Atom">the</span> <span class="s s-Atom">motor</span> <span class="s s-Atom">shaft</span> <span class="nf">counterclockwise</span> <span class="p">(</span><span class="nv">CCW</span><span class="p">)</span>

<span class="s s-Atom">#</span>   <span class="s s-Atom">when</span> <span class="s s-Atom">viewed</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="s s-Atom">rear</span><span class="p">.</span>

<span class="s s-Atom">#</span> <span class="s s-Atom">-----------------------------------------------------------------------------</span>

<span class="s s-Atom">#</span> <span class="nv">Helper</span> <span class="s s-Atom">classes</span>

<span class="s s-Atom">#</span> <span class="s s-Atom">-----------------------------------------------------------------------------</span>

<span class="s s-Atom">class</span> <span class="nv">CommandBuffer</span><span class="o">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Handles building a string of commands to send over serial.</span>

<span class="s s-Atom">    Continuous movement requires a sequence of carefully orchestrated</span>

<span class="s s-Atom">    absolute angle and velocity commands. In order to avoid serial transfer/</span>

<span class="s s-Atom">    ready waiting overhead, it&#39;s</span> <span class="s s-Atom">most</span> <span class="s s-Atom">efficient</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">a</span> <span class="s s-Atom">long</span> <span class="s s-Atom">sequence</span> <span class="s s-Atom">to</span> <span class="s s-Atom">each</span>

    <span class="s s-Atom">stepper</span> <span class="s s-Atom">controller</span><span class="p">,</span> <span class="s s-Atom">and</span> <span class="s s-Atom">then</span> <span class="s s-Atom">run</span> <span class="s s-Atom">them</span> <span class="s s-Atom">all</span> <span class="s s-Atom">together</span><span class="p">.</span>

    <span class="nv">All</span> <span class="s s-Atom">methods</span> <span class="s s-Atom">deal</span> <span class="s s-Atom">in</span> <span class="s s-Atom">strings</span><span class="p">,</span> <span class="o">not</span> <span class="s s-Atom">byte</span> <span class="s s-Atom">objects</span><span class="p">.</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    def __init__(self, addresses):</span>

<span class="s s-Atom">        &#39;&#39;&#39;</span><span class="nv">Addresses</span> <span class="s s-Atom">are</span> <span class="nv">EZStepper</span> <span class="s s-Atom">bus</span> <span class="s s-Atom">addresses</span><span class="p">,</span> <span class="s s-Atom">e</span><span class="p">.</span><span class="s s-Atom">g</span><span class="p">.</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">        self.buffer_map = {address : &#39;&#39; for address in addresses}</span>

<span class="s s-Atom">    def put(self, address, command_str):</span>

<span class="s s-Atom">        self.buffer_map[address] += command_str</span>

<span class="s s-Atom">        logger.debug(f&#39;</span><span class="nv">CommandBuffer</span><span class="o">:</span><span class="nf">put</span><span class="p">()</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span><span class="o">:</span> <span class="p">{</span><span class="s s-Atom">command_str</span><span class="p">}</span> <span class="s s-Atom">-&gt;</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">buffer_map</span><span class="p">[</span><span class="s s-Atom">address</span><span class="p">]}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    def empty(self, address):</span>

<span class="s s-Atom">        &#39;&#39;&#39;</span><span class="nv">Use</span> <span class="s s-Atom">after</span> <span class="s s-Atom">sending&#39;&#39;&#39;</span>

<span class="s s-Atom">        self.buffer_map[address] = &#39;&#39;</span>

<span class="s s-Atom">    def terminate(self, address):</span>

<span class="s s-Atom">        &#39;&#39;&#39;</span><span class="nv">Use</span> <span class="s s-Atom">before</span> <span class="s s-Atom">sending&#39;&#39;&#39;</span>

<span class="s s-Atom">        self.buffer_map[address] += &#39;\r\n&#39;</span>

<span class="s s-Atom">    def get(self, address):</span>

<span class="s s-Atom">        return self.buffer_map[address]</span>

<span class="s s-Atom"># -----------------------------------------------------------------------------</span>

<span class="s s-Atom"># Stepper functions</span>

<span class="s s-Atom"># -----------------------------------------------------------------------------</span>

<span class="s s-Atom">def ezstepper_check_status(resp):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">Compare</span> <span class="s s-Atom">the</span> <span class="s s-Atom">status</span> <span class="s s-Atom">byte</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="nv">EZStepper</span> <span class="s s-Atom">to</span> <span class="s s-Atom">some</span> <span class="s s-Atom">common</span> <span class="s s-Atom">error</span> <span class="s s-Atom">codes</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">resp</span>

        <span class="s s-Atom">bytes</span><span class="p">,</span> <span class="nv">EZStepper</span> <span class="s s-Atom">response</span><span class="p">,</span> <span class="s s-Atom">after</span> <span class="s s-Atom">throwing</span> <span class="s s-Atom">away</span> <span class="s s-Atom">garbage</span> <span class="s s-Atom">bytes</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">status_good</span>

        <span class="s s-Atom">bool</span><span class="p">,</span> <span class="nv">True</span> <span class="s s-Atom">if</span> <span class="s s-Atom">response</span> <span class="o">is</span> <span class="s s-Atom">nonempty</span> <span class="s s-Atom">and</span> <span class="s s-Atom">no</span> <span class="s s-Atom">unusual</span> <span class="s s-Atom">status</span> <span class="s s-Atom">byte</span> <span class="s s-Atom">patterns</span> <span class="s s-Atom">found</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    status_good = True</span>

<span class="s s-Atom">    if resp:</span>

<span class="s s-Atom">        # bits 0-3 form an error code: see EZStepper docs</span>

<span class="s s-Atom">        status = resp[IDX_STATUS_BYTE] &amp; 0b00001111</span>

<span class="s s-Atom">    else:</span>

<span class="s s-Atom">        status = b&#39;&#39;</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if 2 == status:</span>

<span class="s s-Atom">        logger.warning(&#39;</span><span class="nv">Bad</span> <span class="s s-Atom">command</span> <span class="nf">error</span> <span class="p">(</span><span class="s s-Atom">illegal</span> <span class="s s-Atom">command</span> <span class="s s-Atom">was</span> <span class="s s-Atom">sent</span><span class="p">)</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if 5 == status:</span>

<span class="s s-Atom">        logger.warning(&#39;</span><span class="nv">Communications</span> <span class="nv">Error</span> <span class="p">(</span><span class="nv">Internal</span> <span class="s s-Atom">communications</span> <span class="s s-Atom">error</span><span class="p">)</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if 9 == status:</span>

<span class="s s-Atom">        logger.warning(&#39;</span><span class="nv">Overload</span> <span class="nf">error</span> <span class="p">(</span><span class="nv">Physical</span> <span class="s s-Atom">system</span> <span class="s s-Atom">could</span> <span class="o">not</span> <span class="s s-Atom">keep</span> <span class="s s-Atom">up</span> <span class="s s-Atom">with</span> <span class="s s-Atom">commanded</span> <span class="s s-Atom">position</span><span class="p">)</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if 11 == status:</span>

<span class="s s-Atom">        logger.warning(&#39;</span><span class="nv">Move</span> <span class="o">not</span> <span class="s s-Atom">allowed&#39;)</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if 15 == status:</span>

<span class="s s-Atom">        logger.warning(&#39;</span><span class="nv">Command</span> <span class="nf">overflow</span> <span class="p">(</span><span class="s s-Atom">unit</span> <span class="s s-Atom">was</span> <span class="s s-Atom">already</span> <span class="s s-Atom">executing</span> <span class="s s-Atom">a</span> <span class="s s-Atom">command</span> <span class="s s-Atom">when</span> <span class="s s-Atom">another</span> <span class="s s-Atom">command</span> <span class="s s-Atom">was</span> <span class="s s-Atom">received</span><span class="p">)</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        status_good = False</span>

<span class="s s-Atom">    if status not in [b&#39;&#39;, 0, 2, 9, 11, 15]:</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Unrecognized</span> <span class="s s-Atom">error</span> <span class="s s-Atom">code</span> <span class="p">{</span><span class="s s-Atom">status</span><span class="p">}.</span> <span class="nv">Consult</span> <span class="nv">EZStepper</span> <span class="s s-Atom">documentation</span><span class="p">.</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    return status_good</span>

<span class="s s-Atom">def ezstepper_check_ready(resp):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">The</span> <span class="nv">EZStepper</span> <span class="o">is</span> <span class="s s-Atom">ready</span> <span class="s s-Atom">to</span> <span class="s s-Atom">accept</span> <span class="s s-Atom">a</span> <span class="s s-Atom">new</span> <span class="s s-Atom">command</span> <span class="s s-Atom">if</span> <span class="s s-Atom">the</span> <span class="s s-Atom">ready</span> <span class="s s-Atom">bit</span> <span class="o">is</span> <span class="s s-Atom">set</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">resp</span>

        <span class="s s-Atom">bytes</span><span class="p">,</span> <span class="nv">EZStepper</span> <span class="s s-Atom">response</span><span class="p">,</span> <span class="s s-Atom">after</span> <span class="s s-Atom">throwing</span> <span class="s s-Atom">away</span> <span class="s s-Atom">garbage</span> <span class="s s-Atom">bytes</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">bool</span>

        <span class="nv">True</span> <span class="s s-Atom">if</span> <span class="s s-Atom">ready</span> <span class="s s-Atom">bit</span> <span class="o">is</span> <span class="s s-Atom">set</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    return bool(resp[IDX_READY_BIT] &amp; 0b00100000)</span>

<span class="s s-Atom">def wait_for_ready(ser, address, ready_timeout=10.0):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">address</span>

        <span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">address</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ezstepper</span>

    <span class="nf">ready_timeout</span> <span class="p">(</span><span class="s s-Atom">optional</span><span class="p">)</span>

        <span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">time</span> <span class="s s-Atom">in</span> <span class="s s-Atom">seconds</span> <span class="s s-Atom">before</span> <span class="s s-Atom">deciding</span> <span class="s s-Atom">the</span> <span class="s s-Atom">stepper</span> <span class="o">is</span> <span class="s s-Atom">unresponsive</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    resp = b&#39;&#39;</span>

<span class="s s-Atom">    ready = False</span>

<span class="s s-Atom">    if &#39;</span><span class="k">_</span><span class="s s-Atom">&#39; != address:</span>

<span class="s s-Atom">        # only send a new command if ezstepper not busy</span>

<span class="s s-Atom">        start_busywait = time.time()</span>

<span class="s s-Atom">        query = (f&#39;/</span><span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span><span class="nv">Q</span><span class="s s-Atom">\r\n&#39;).encode()</span>

<span class="s s-Atom">        while not ready and (time.time() - start_busywait) &lt; ready_timeout:</span>

<span class="s s-Atom">            ser.write(query)</span>

<span class="s s-Atom">            line = ser.readline()</span>

<span class="s s-Atom">            if line:</span>

<span class="s s-Atom">                resp = look_for_response(line)</span>

<span class="s s-Atom">            logger.debug(f&#39;</span><span class="nv">Ready</span> <span class="s s-Atom">response</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">            if resp:</span>

<span class="s s-Atom">                ready = ezstepper_check_ready(resp)</span>

<span class="s s-Atom">        status_good = ezstepper_check_status(resp)</span>

<span class="s s-Atom">        logger.debug(f&#39;</span><span class="nv">Waited</span> <span class="p">{</span><span class="s s-Atom">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="s s-Atom">start_busywait</span><span class="o">:</span><span class="mf">.4</span><span class="s s-Atom">f</span><span class="p">}</span> <span class="s s-Atom">sec</span> <span class="s s-Atom">for</span> <span class="s s-Atom">ready</span> <span class="s s-Atom">signal&#39;)</span>

<span class="s s-Atom">        if not ready:</span>

<span class="s s-Atom">            logger.warning(f&#39;</span><span class="nv">EZStepper</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">was</span> <span class="o">not</span> <span class="s s-Atom">ready</span> <span class="s s-Atom">in</span> <span class="s s-Atom">allotted</span> <span class="s s-Atom">time</span> <span class="p">{</span><span class="s s-Atom">ready_timeout</span><span class="p">}</span> <span class="s s-Atom">sec&#39;)</span>

<span class="s s-Atom">    return</span>

<span class="s s-Atom">def look_for_response(resp):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">Responses</span> <span class="s s-Atom">addressed</span> <span class="s s-Atom">to</span> <span class="s s-Atom">the</span> <span class="s s-Atom">controller</span> <span class="s s-Atom">node</span> <span class="s s-Atom">begin</span> <span class="s s-Atom">with</span> <span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="s s-Atom">with</span> <span class="s s-Atom">possible</span>

    <span class="s s-Atom">junk</span> <span class="s s-Atom">before</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">resp</span>

        <span class="s s-Atom">bytes</span><span class="p">,</span> <span class="nv">EZStepper</span> <span class="s s-Atom">response</span><span class="p">,</span> <span class="s s-Atom">straight</span> <span class="s s-Atom">out</span> <span class="s s-Atom">of</span> <span class="s s-Atom">serial</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">resp</span>

        <span class="nv">Any</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">after</span> <span class="o">/</span><span class="mi">0</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    if (b&#39;</span><span class="o">/</span><span class="sc">0&#39; </span><span class="s s-Atom">in</span> <span class="s s-Atom">resp</span><span class="p">)</span> <span class="nf">and</span> <span class="p">(</span><span class="s s-Atom">b&#39;\x03&#39;</span> <span class="s s-Atom">in</span> <span class="s s-Atom">resp</span><span class="p">)</span><span class="o">:</span>

        <span class="s s-Atom">resp</span> <span class="o">=</span> <span class="s s-Atom">resp</span><span class="p">[</span><span class="s s-Atom">resp</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="s s-Atom">b&#39;/0&#39;</span><span class="p">)</span><span class="o">:</span><span class="p">]</span>

    <span class="s s-Atom">else</span><span class="p">:</span>

        <span class="s s-Atom">resp</span> <span class="o">=</span> <span class="s s-Atom">b&#39;&#39;</span>

    <span class="s s-Atom">return</span> <span class="s s-Atom">resp</span>

<span class="s s-Atom">def</span> <span class="nf">ezstepper_write</span><span class="p">(</span><span class="s s-Atom">ser</span><span class="p">:</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="s s-Atom">address</span><span class="p">,</span> <span class="s s-Atom">command_str</span><span class="o">:</span> <span class="s s-Atom">str</span><span class="p">)</span><span class="o">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Builds a serial command to send to EZStepper(s), checks status bytes in</span>

<span class="s s-Atom">    response, and returns response bytes.</span>

<span class="s s-Atom">    Parameters</span>

<span class="s s-Atom">    ----------</span>

<span class="s s-Atom">    ser</span>

<span class="s s-Atom">        pyserial instance, the port to send bytes over from</span>

<span class="s s-Atom">    address</span>

<span class="s s-Atom">        str, address of ezstepper</span>

<span class="s s-Atom">    command_str</span>

<span class="s s-Atom">        string, chars to send over EZStepper bus</span>

<span class="s s-Atom">    Returns</span>

<span class="s s-Atom">    -------</span>

<span class="s s-Atom">    resp</span>

<span class="s s-Atom">        bytes, serial response from EZStepper</span>

<span class="s s-Atom">    Example:</span>

<span class="s s-Atom">    ```</span>

<span class="s s-Atom">    ezstepper.write(ser, 1, &#39;</span><span class="nv">A1000R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    ezstepper.write(ser, &#39;</span><span class="k">_</span><span class="s s-Atom">&#39;, &#39;</span><span class="nv">A12000</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    ezstepper.write(ser, &#39;</span><span class="k">_</span><span class="s s-Atom">&#39;, &#39;</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    ```</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="s s-Atom">ser</span><span class="p">.</span><span class="nf">write</span><span class="p">((</span><span class="s s-Atom">f&#39;/{address}&#39;</span> <span class="o">+</span> <span class="s s-Atom">command_str</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>

    <span class="s s-Atom">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s s-Atom">&#39;EZStepper cmd: {}&#39;</span><span class="p">.</span><span class="nf">format</span><span class="p">((</span><span class="s s-Atom">f&#39;/{address}&#39;</span> <span class="o">+</span> <span class="s s-Atom">command_str</span><span class="p">).</span><span class="nf">rstrip</span><span class="p">(</span><span class="s s-Atom">&#39;\r\n&#39;</span><span class="p">)))</span>

    <span class="s s-Atom">#</span> <span class="s s-Atom">we</span> <span class="s s-Atom">do</span> <span class="o">not</span> <span class="s s-Atom">anticipate</span> <span class="s s-Atom">a</span> <span class="s s-Atom">response</span> <span class="s s-Atom">from</span> <span class="s2">&quot;all call&quot;</span> <span class="s s-Atom">commands</span><span class="p">.</span>

    <span class="s s-Atom">if</span> <span class="s s-Atom">&#39;_&#39;</span> <span class="o">==</span> <span class="s s-Atom">address</span><span class="p">:</span>

        <span class="s s-Atom">resp</span> <span class="o">=</span> <span class="s s-Atom">b&#39;&#39;</span>

    <span class="s s-Atom">else</span><span class="p">:</span>

        <span class="s s-Atom">resp</span> <span class="o">=</span> <span class="nf">look_for_response</span><span class="p">(</span><span class="s s-Atom">ser</span><span class="p">.</span><span class="nf">readline</span><span class="p">())</span>

        <span class="s s-Atom">status_good</span> <span class="o">=</span> <span class="nf">ezstepper_check_status</span><span class="p">(</span><span class="s s-Atom">resp</span><span class="p">)</span>

    <span class="s s-Atom">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s s-Atom">&#39;EZStepper response: {}&#39;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="s s-Atom">resp</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="s s-Atom">b&#39;\r\n&#39;</span><span class="p">)))</span>

    <span class="s s-Atom">return</span> <span class="s s-Atom">resp</span>

<span class="s s-Atom">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span><span class="s s-Atom">ser</span><span class="p">:</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="s s-Atom">address</span><span class="p">)</span><span class="o">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Gets EZStepper&#39;s</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">counts</span> <span class="s s-Atom">in</span> <span class="s s-Atom">terms</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ticks</span><span class="p">.</span> <span class="nv">It</span> <span class="o">is</span> <span class="s s-Atom">critical</span> <span class="s s-Atom">for</span>

    <span class="s s-Atom">accurate</span> <span class="s s-Atom">operation</span> <span class="s s-Atom">that</span> <span class="s s-Atom">this</span> <span class="s s-Atom">call</span> <span class="s s-Atom">succeeds</span><span class="p">,</span> <span class="s s-Atom">so</span> <span class="s s-Atom">the</span> <span class="s s-Atom">program</span> <span class="s s-Atom">will</span> <span class="s s-Atom">exit</span>

    <span class="s s-Atom">if</span> <span class="s s-Atom">it</span> <span class="s s-Atom">fails</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">address</span>

        <span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">address</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ezstepper</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">ticks</span>

        <span class="nv">Number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">counted</span> <span class="s s-Atom">by</span> <span class="s s-Atom">encoder</span><span class="p">.</span> <span class="nv">A</span> <span class="mi">10000</span> <span class="s s-Atom">line</span> <span class="s s-Atom">encoder</span>

        <span class="s s-Atom">has</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">=</span> <span class="mi">40000</span> <span class="s s-Atom">lines</span> <span class="s s-Atom">per</span> <span class="s s-Atom">revolution</span><span class="p">.</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    ticks = 0</span>

<span class="s s-Atom">    resp = ezstepper_write(ser, address, &#39;</span><span class="nb">?</span><span class="mi">8</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    retries = 10</span>

<span class="s s-Atom">    while not resp and retries &gt; 0:</span>

<span class="s s-Atom">        resp = ezstepper_write(ser, address, &#39;</span><span class="nb">?</span><span class="mi">8</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">        retries -= 1</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">was</span> <span class="s s-Atom">slow</span> <span class="s s-Atom">to</span> <span class="s s-Atom">respond</span><span class="p">.</span> <span class="nv">Retrying</span><span class="p">,</span> <span class="p">{</span><span class="s s-Atom">retries</span><span class="p">}</span> <span class="s s-Atom">remaining</span><span class="p">.</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    retries = 10</span>

<span class="s s-Atom">    while not ezstepper_check_status(resp) and retries &gt; 0:</span>

<span class="s s-Atom">        retries -= 1</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">status</span> <span class="s s-Atom">was</span> <span class="s s-Atom">bad</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}.</span> <span class="nv">Retrying</span><span class="p">,</span> <span class="p">{</span><span class="s s-Atom">retries</span><span class="p">}</span> <span class="s s-Atom">remaining</span><span class="p">.</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    if retries &lt; 0:</span>

<span class="s s-Atom">        logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">status</span> <span class="s s-Atom">bad</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}.</span> <span class="nv">Is</span> <span class="nv">EZStepper</span><span class="o">/</span><span class="s s-Atom">encoder</span> <span class="s s-Atom">connected</span><span class="nb">?</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        sys.exit(1)</span>

<span class="s s-Atom">    else:</span>

<span class="s s-Atom">        payload = resp[IDX_STATUS_BYTE+1:-NUM_TRAILING_BYTES]</span>

<span class="s s-Atom">        logger.debug(f&#39;</span><span class="nv">Encoder</span> <span class="s s-Atom">reading</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">payload</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        if payload:</span>

<span class="s s-Atom">            ticks = int(payload.decode(&#39;utf</span><span class="o">-</span><span class="mi">8</span><span class="s s-Atom">&#39;))</span>

<span class="s s-Atom">        else:</span>

<span class="s s-Atom">            logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">didn\&#39;t respond.&#39;</span><span class="p">)</span>

            <span class="s s-Atom">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="s s-Atom">return</span> <span class="s s-Atom">ticks</span>

<span class="s s-Atom">def</span> <span class="nf">bump_hard_stop</span><span class="p">(</span><span class="s s-Atom">ser</span><span class="p">:</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="s s-Atom">address</span><span class="p">:</span> <span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">ticks</span><span class="p">:</span> <span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">speed</span><span class="p">:</span> <span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">hold_current</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="s s-Atom">move_current</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Run the motor backward until it can&#39;t</span> <span class="s s-Atom">anymore</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">address</span>

        <span class="s s-Atom">ezstepper</span> <span class="s s-Atom">selector</span> <span class="s s-Atom">switch</span> <span class="s s-Atom">number</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">command</span> <span class="s s-Atom">to</span>

    <span class="s s-Atom">ticks</span>

        <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">to</span> <span class="s s-Atom">move</span> <span class="s s-Atom">on</span> <span class="s s-Atom">each</span> <span class="s s-Atom">trial</span> <span class="s s-Atom">while</span> <span class="s s-Atom">searching</span> <span class="s s-Atom">for</span> <span class="s s-Atom">hard</span> <span class="s s-Atom">stop</span>

    <span class="s s-Atom">speed</span>

        <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">per</span> <span class="s s-Atom">second</span>

    <span class="nf">hold_current</span> <span class="p">(</span><span class="s s-Atom">optional</span><span class="p">)</span>

        <span class="s s-Atom">target</span> <span class="s s-Atom">current</span><span class="p">,</span> <span class="c1">% of 2 A limit for motor when stationary</span>

    <span class="nf">move_current</span> <span class="p">(</span><span class="s s-Atom">optional</span><span class="p">)</span>

        <span class="s s-Atom">target</span> <span class="s s-Atom">current</span><span class="p">,</span> <span class="c1">% of 2 A limit for motor when moving</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">prev_ticks</span>

        <span class="nv">The</span> <span class="s s-Atom">last</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">position</span> <span class="s s-Atom">before</span> <span class="s s-Atom">the</span> <span class="s s-Atom">hard</span> <span class="s s-Atom">stop</span> <span class="s s-Atom">was</span> <span class="s s-Atom">hit</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    max_tries = 10000 # may take several moves to hit a hard stop</span>

<span class="s s-Atom">    tries = 0</span>

<span class="s s-Atom">    prev_ticks = 800000 # more ticks than we have total available cable</span>

<span class="s s-Atom">    curr_ticks = prev_ticks - 1</span>

<span class="s s-Atom">    while ((curr_ticks &lt; prev_ticks) and (tries &lt; max_tries)):</span>

<span class="s s-Atom">        prev_ticks = curr_ticks</span>

<span class="s s-Atom">        wait_for_ready(ser, address)</span>

<span class="s s-Atom">        resp = ezstepper_write(</span>

<span class="s s-Atom">            ser,</span>

<span class="s s-Atom">            address,</span>

<span class="s s-Atom">            (</span>

<span class="s s-Atom">                f&#39;m</span><span class="p">{</span><span class="s s-Atom">move_current</span><span class="p">}</span><span class="s s-Atom">&#39; +</span>

<span class="s s-Atom">                f&#39;h</span><span class="p">{</span><span class="s s-Atom">hold_current</span><span class="p">}</span><span class="s s-Atom">&#39; +</span>

<span class="s s-Atom">                f&#39;</span><span class="nv">V</span><span class="p">{</span><span class="s s-Atom">speed</span><span class="p">}</span><span class="s s-Atom">&#39; +</span>

<span class="s s-Atom">                f&#39;</span><span class="nv">D</span><span class="p">{</span><span class="s s-Atom">ticks</span><span class="p">}</span><span class="s s-Atom">&#39; +</span>

<span class="s s-Atom">                &#39;</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;</span>

<span class="s s-Atom">            )</span>

<span class="s s-Atom">        )</span>

<span class="s s-Atom">        curr_ticks = get_encoder_pos(ser, address)</span>

<span class="s s-Atom">        tries += 1</span>

<span class="s s-Atom">    return prev_ticks</span>

<span class="s s-Atom">def all_steppers_ez(ser: StepperSerial, addresses: list, radians: list, run=True):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">Send</span> <span class="s s-Atom">serial</span> <span class="s s-Atom">commands</span> <span class="s s-Atom">to</span> <span class="nv">AllMotion</span> <span class="nv">EZHR17EN</span> <span class="s s-Atom">driver</span> <span class="s s-Atom">boards</span><span class="p">.</span>

    <span class="nv">Driver</span> <span class="s s-Atom">boards</span> <span class="s s-Atom">should</span> <span class="s s-Atom">already</span> <span class="s s-Atom">be</span> <span class="s s-Atom">in</span> <span class="s s-Atom">position</span><span class="o">-</span><span class="s s-Atom">correction</span> <span class="s s-Atom">mode</span><span class="p">,</span> <span class="s s-Atom">so</span> <span class="s s-Atom">will</span> <span class="s s-Atom">take</span>

    <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">as</span> <span class="s s-Atom">commands</span><span class="p">.</span> <span class="nv">The</span> <span class="s s-Atom">driver</span> <span class="s s-Atom">boards</span> <span class="s s-Atom">handle</span> <span class="s s-Atom">achieving</span> <span class="s s-Atom">the</span> <span class="s s-Atom">requested</span>

    <span class="s s-Atom">absolute</span> <span class="s s-Atom">position</span><span class="p">.</span>

    <span class="nv">Commands</span> <span class="s s-Atom">in</span> <span class="s s-Atom">radians</span> <span class="s s-Atom">are</span> <span class="s s-Atom">converted</span> <span class="s s-Atom">to</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">and</span> <span class="s s-Atom">sent</span> <span class="s s-Atom">to</span> <span class="s s-Atom">driver</span>

    <span class="s s-Atom">boards</span> <span class="s s-Atom">in</span> <span class="s s-Atom">order</span><span class="p">,</span> <span class="s s-Atom">based</span> <span class="s s-Atom">on</span> <span class="s s-Atom">their</span> <span class="s s-Atom">addresses</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">].</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">addresses</span>

        <span class="s s-Atom">iterable</span> <span class="s s-Atom">of</span> <span class="s s-Atom">addresses</span> <span class="s s-Atom">e</span><span class="p">.</span><span class="s s-Atom">g</span><span class="p">.</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="s s-Atom">to</span> <span class="s s-Atom">route</span> <span class="s s-Atom">commands</span> <span class="s s-Atom">to</span>

    <span class="s s-Atom">radians</span>

        <span class="s s-Atom">iterable</span> <span class="s s-Atom">of</span> <span class="s s-Atom">signed</span> <span class="s s-Atom">angle</span> <span class="s s-Atom">to</span> <span class="s s-Atom">move</span> <span class="s s-Atom">each</span> <span class="s s-Atom">stepper</span> <span class="nf">to</span> <span class="p">(</span><span class="s s-Atom">radians</span><span class="p">)</span>

    <span class="nf">run</span> <span class="p">(</span><span class="s s-Atom">optional</span><span class="p">)</span>

        <span class="nv">If</span> <span class="nv">True</span><span class="p">,</span> <span class="s s-Atom">execute</span> <span class="nv">EZStepper</span> <span class="s s-Atom">command</span> <span class="s s-Atom">buffer</span> <span class="s s-Atom">after</span> <span class="s s-Atom">adding</span> <span class="s s-Atom">to</span> <span class="s s-Atom">it</span><span class="p">.</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">ticks_to_go</span>

        <span class="s s-Atom">iterable</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">reporting</span> <span class="s s-Atom">the</span> <span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">moved</span> <span class="s s-Atom">by</span>

        <span class="s s-Atom">each</span> <span class="s s-Atom">stepper</span>

    <span class="s s-Atom">err</span>

        <span class="s s-Atom">iterable</span> <span class="s s-Atom">of</span> <span class="s s-Atom">rounding</span> <span class="s s-Atom">errors</span> <span class="s s-Atom">incurred</span> <span class="s s-Atom">by</span> <span class="s s-Atom">converting</span> <span class="s s-Atom">radians</span> <span class="s s-Atom">to</span> <span class="s s-Atom">encoder</span>

        <span class="s s-Atom">ticks</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    # Get the current absolute encoder position</span>

<span class="s s-Atom">    current_ticks_raw = [get_encoder_pos(ser, address) for address in addresses]</span>

<span class="s s-Atom">    current_ticks = current_ticks_raw</span>

<span class="s s-Atom">    logger.debug(f&#39;</span><span class="nv">Current</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">positions</span> <span class="s s-Atom">before</span> <span class="s s-Atom">move</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">current_ticks</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    # Get the final absolute position</span>

<span class="s s-Atom">    radians = np.array(radians)</span>

<span class="s s-Atom">    ticks_float = radians * const.DEG_PER_RAD / const.DEG_PER_STEP / const.STEP_PER_TICK</span>

<span class="s s-Atom">    ticks_int = np.round(ticks_float).astype(int)</span>

<span class="s s-Atom">    ticks_to_go = np.round(ticks_float - current_ticks).astype(int)</span>

<span class="s s-Atom">    err = (ticks_float - current_ticks) - ticks_to_go</span>

<span class="s s-Atom">    logger.debug(f&#39;</span><span class="nv">Commanded</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">positions</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">ticks_int</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    logger.debug(f&#39;</span><span class="nv">Delta</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">positions</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">ticks_to_go</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    if any([tick_int &lt; 0 for tick_int in ticks_int]):</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Move</span> <span class="s s-Atom">command</span> <span class="s s-Atom">past</span> <span class="s s-Atom">hard</span> <span class="s s-Atom">stop</span> <span class="s s-Atom">detected</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">addresses</span><span class="p">}</span> <span class="o">:</span> <span class="p">{</span><span class="s s-Atom">ticks_int</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    # Set the velocity of each motor such that they arrive at the final</span>

<span class="s s-Atom">    # position at the same time.</span>

<span class="s s-Atom">    # The motor with the longest move moves at the maximum velocity.</span>

<span class="s s-Atom">    max_ticks = np.max(np.abs(ticks_to_go))</span>

<span class="s s-Atom">    t_move = max(max_ticks / const.MAX_SPEED_TICKS, 1e-9)</span>

<span class="s s-Atom">    vels = np.round(np.abs(ticks_to_go) / t_move).astype(int)</span>

<span class="s s-Atom">    logger.debug(f&#39;</span><span class="nv">Motor</span> <span class="s s-Atom">speeds</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">vels</span><span class="p">}</span> <span class="s s-Atom">ticks</span> <span class="o">/</span> <span class="s s-Atom">sec&#39;)</span>

<span class="s s-Atom">    for i in range(len(ticks_to_go)):</span>

<span class="s s-Atom">        if (ticks_to_go[i] and vels[i]):</span>

<span class="s s-Atom">            # Set velocity and command absolute encoder ticks</span>

<span class="s s-Atom">            wait_for_ready(ser, addresses[i])</span>

<span class="s s-Atom">            resp = ezstepper_write(</span>

<span class="s s-Atom">                ser,</span>

<span class="s s-Atom">                addresses[i],</span>

<span class="s s-Atom">                (</span>

<span class="s s-Atom">                    f&#39;</span><span class="nv">V</span><span class="p">{</span><span class="s s-Atom">vels</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]}</span><span class="s s-Atom">&#39; +</span>

<span class="s s-Atom">                    f&#39;</span><span class="nv">A</span><span class="p">{</span><span class="s s-Atom">ticks_int</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]}</span><span class="s s-Atom">&#39;</span>

<span class="s s-Atom">                  + &#39;\r\n&#39;</span>

<span class="s s-Atom">                )</span>

<span class="s s-Atom">            )</span>

<span class="s s-Atom">    # Execute buffered move commands for all addresses</span>

<span class="s s-Atom">    if run:</span>

<span class="s s-Atom">        ezstepper_write(ser, &#39;</span><span class="k">_</span><span class="s s-Atom">&#39;, &#39;</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    return ticks_to_go, err</span>

<span class="s s-Atom"># -----------------------------------------------------------------------------</span>

<span class="s s-Atom"># Hawkeye functions</span>

<span class="s s-Atom"># -----------------------------------------------------------------------------</span>

<span class="s s-Atom">def send_hawkeye_byte(ser: HawkeyeSerial, data: int):</span>

<span class="s s-Atom">    &#39;&#39;&#39;</span>

    <span class="nv">Control</span> <span class="s s-Atom">three</span> <span class="s s-Atom">groups</span> <span class="s s-Atom">of</span> <span class="nv">Hawkeye</span> <span class="nv">IR</span> <span class="s s-Atom">sources</span> <span class="s s-Atom">on</span> <span class="s s-Atom">the</span> <span class="s s-Atom">raft</span><span class="p">.</span> <span class="nv">Each</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">first</span>

    <span class="s s-Atom">three</span> <span class="s s-Atom">bits</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="err">`</span><span class="s s-Atom">data</span><span class="err">`</span> <span class="s s-Atom">byte</span> <span class="s s-Atom">turns</span> <span class="s s-Atom">on</span> <span class="s s-Atom">one</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">three</span> <span class="s s-Atom">available</span> <span class="s s-Atom">groups</span> <span class="s s-Atom">of</span>

    <span class="nv">Hawkeyes</span> <span class="s s-Atom">on</span> <span class="s s-Atom">the</span> <span class="s s-Atom">raft</span><span class="p">:</span> <span class="s s-Atom">center</span><span class="p">,</span> <span class="s s-Atom">inner</span> <span class="s s-Atom">ring</span><span class="p">,</span> <span class="s s-Atom">and</span> <span class="s s-Atom">outer</span> <span class="s s-Atom">ring</span><span class="p">.</span>

    <span class="nv">The</span> <span class="s s-Atom">byte</span> <span class="o">is</span> <span class="s s-Atom">sent</span> <span class="s s-Atom">over</span> <span class="s s-Atom">serial</span> <span class="s s-Atom">to</span> <span class="s s-Atom">a</span> <span class="s s-Atom">microcontroller</span><span class="p">,</span> <span class="s s-Atom">which</span> <span class="s s-Atom">forwards</span> <span class="s s-Atom">the</span> <span class="s s-Atom">byte</span>

    <span class="s s-Atom">to</span> <span class="s s-Atom">a</span> <span class="s s-Atom">shift</span> <span class="s s-Atom">register</span> <span class="s s-Atom">on</span> <span class="s s-Atom">the</span> <span class="s s-Atom">raft</span> <span class="s s-Atom">via</span> <span class="nv">SPI</span><span class="p">.</span>

    <span class="nv">For</span> <span class="s s-Atom">example</span><span class="p">:</span>

    <span class="o">-</span> <span class="s s-Atom">data</span> <span class="o">=</span> <span class="mi">1</span> <span class="s s-Atom">-&gt;</span> <span class="mi">001</span> <span class="s s-Atom">-&gt;</span> <span class="s s-Atom">center</span> <span class="nv">Hawkeye</span> <span class="s s-Atom">only</span>

    <span class="o">-</span> <span class="s s-Atom">data</span> <span class="o">=</span> <span class="mi">2</span> <span class="s s-Atom">-&gt;</span> <span class="mi">010</span> <span class="s s-Atom">-&gt;</span> <span class="s s-Atom">inner</span> <span class="s s-Atom">ring</span> <span class="s s-Atom">only</span>

    <span class="o">-</span> <span class="s s-Atom">data</span> <span class="o">=</span> <span class="mi">3</span> <span class="s s-Atom">-&gt;</span> <span class="mi">011</span> <span class="s s-Atom">-&gt;</span> <span class="s s-Atom">center</span> <span class="s s-Atom">and</span> <span class="s s-Atom">inner</span>

    <span class="o">-</span> <span class="s s-Atom">data</span> <span class="o">=</span> <span class="mi">7</span> <span class="s s-Atom">-&gt;</span> <span class="mi">111</span> <span class="s s-Atom">-&gt;</span> <span class="s s-Atom">center</span><span class="p">,</span> <span class="s s-Atom">inner</span><span class="p">,</span> <span class="s s-Atom">outer</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">byte</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="nf">data</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span>

        <span class="s s-Atom">integer</span> <span class="s s-Atom">whose</span> <span class="s s-Atom">binary</span> <span class="s s-Atom">representation</span> <span class="s s-Atom">will</span> <span class="s s-Atom">appear</span> <span class="s s-Atom">at</span> <span class="s s-Atom">the</span> <span class="s s-Atom">shift</span> <span class="s s-Atom">register</span>

        <span class="s s-Atom">outputs</span> <span class="s s-Atom">on</span> <span class="s s-Atom">the</span> <span class="s s-Atom">raft</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    assert isinstance(data, int)</span>

<span class="s s-Atom">    if data &gt; 255:</span>

<span class="s s-Atom">        data = 255</span>

<span class="s s-Atom">    if data &lt; 0:</span>

<span class="s s-Atom">        data = 0</span>

<span class="s s-Atom">    ser.write(f&#39;</span><span class="p">{</span><span class="s s-Atom">data</span><span class="p">}</span><span class="s s-Atom">\r\n</span><span class="err">&#39;</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>

    <span class="s s-Atom">return</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">IDX_READY_BIT</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">IDX_STATUS_BYTE</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">NUM_TRAILING_BYTES</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">logger</span>
</code></pre></div>

<h2 id="functions">Functions</h2>
<h3 id="all_steppers_ez">all_steppers_ez</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">all_steppers_ez</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span> <span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">radians</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">run</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<p>Send serial commands to AllMotion EZHR17EN driver boards.</p>
<p>Driver boards should already be in position-correction mode, so will take
encoder ticks as commands. The driver boards handle achieving the requested
absolute position.
Commands in radians are converted to encoder ticks and sent to driver
boards in order, based on their addresses [1,2,3,4].</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>addresses</td>
<td>None</td>
<td>iterable of addresses e.g. [1,2,3,4] to route commands to</td>
<td>None</td>
</tr>
<tr>
<td>radians</td>
<td>None</td>
<td>iterable of signed angle to move each stepper to (radians)</td>
<td>None</td>
</tr>
<tr>
<td>run (optional)</td>
<td>None</td>
<td>If True, execute EZStepper command buffer after adding to it.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ticks_to_go</td>
<td>iterable of integers reporting the number of encoder ticks moved by<br>each stepper</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">all_steppers_ez</span><span class="p">(</span><span class="nl">ser</span><span class="p">:</span><span class="w"> </span><span class="n">StepperSerial</span><span class="p">,</span><span class="w"> </span><span class="nl">addresses</span><span class="p">:</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="nf">radians</span><span class="err">:</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Send serial commands to AllMotion EZHR17EN driver boards.</span>

<span class="s1">    Driver boards should already be in position-correction mode, so will take</span>

<span class="s1">    encoder ticks as commands. The driver boards handle achieving the requested</span>

<span class="s1">    absolute position.</span>

<span class="s1">    Commands in radians are converted to encoder ticks and sent to driver</span>

<span class="s1">    boards in order, based on their addresses [1,2,3,4].</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    ser</span>

<span class="s1">        pyserial instance, the port to send bytes over from</span>

<span class="s1">    addresses</span>

<span class="s1">        iterable of addresses e.g. [1,2,3,4] to route commands to</span>

<span class="s1">    radians</span>

<span class="s1">        iterable of signed angle to move each stepper to (radians)</span>

<span class="s1">    run (optional)</span>

<span class="s1">        If True, execute EZStepper command buffer after adding to it.</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    ticks_to_go</span>

<span class="s1">        iterable of integers reporting the number of encoder ticks moved by</span>

<span class="s1">        each stepper</span>

<span class="s1">    err</span>

<span class="s1">        iterable of rounding errors incurred by converting radians to encoder</span>

<span class="s1">        ticks</span>

<span class="s1">    &#39;&#39;&#39;</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="k">position</span>

<span class="w">    </span><span class="n">current_ticks_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">get_encoder_pos(ser, address) for address in addresses</span><span class="o">]</span>

<span class="w">    </span><span class="n">current_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_ticks_raw</span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Current encoder positions before move: {current_ticks}&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="k">position</span>

<span class="w">    </span><span class="nf">radians</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="nf">radians</span><span class="p">)</span>

<span class="w">    </span><span class="n">ticks_float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">radians</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">DEG_PER_RAD</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">DEG_PER_STEP</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">STEP_PER_TICK</span>

<span class="w">    </span><span class="n">ticks_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">ticks_float</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span>

<span class="w">    </span><span class="n">ticks_to_go</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">ticks_float</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_ticks</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span>

<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ticks_float</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_ticks</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ticks_to_go</span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Commanded encoder positions: {ticks_int}&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Delta encoder positions: {ticks_to_go}&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">any</span><span class="p">(</span><span class="o">[</span><span class="n">tick_int &lt; 0 for tick_int in ticks_int</span><span class="o">]</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Move command past hard stop detected: {addresses} : {ticks_int}&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">arrive</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">final</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">longest</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">velocity</span><span class="p">.</span>

<span class="w">    </span><span class="n">max_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">))</span>

<span class="w">    </span><span class="n">t_move</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">max_ticks</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">MAX_SPEED_TICKS</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">)</span>

<span class="w">    </span><span class="n">vels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">t_move</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Motor speeds: {vels} ticks / sec&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">))</span><span class="err">:</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ticks_to_go</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">vels</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">ticks</span>

<span class="w">            </span><span class="n">wait_for_ready</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="w"> </span><span class="n">addresses</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span>

<span class="w">            </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezstepper_write</span><span class="p">(</span>

<span class="w">                </span><span class="n">ser</span><span class="p">,</span>

<span class="w">                </span><span class="n">addresses</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span>

<span class="w">                </span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;V{vels[i]}&#39;</span><span class="w"> </span><span class="o">+</span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;A{ticks_int[i]}&#39;</span>

<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\r\n&#39;</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Execute</span><span class="w"> </span><span class="n">buffered</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">addresses</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nl">run</span><span class="p">:</span>

<span class="w">        </span><span class="n">ezstepper_write</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;R\r\n&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ticks_to_go</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
</code></pre></div>

</details>
<h3 id="bump_hard_stop">bump_hard_stop</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">bump_hard_stop</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span> <span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ticks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">speed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">hold_current</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">move_current</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
</code></pre></div>

<p>Run the motor backward until it can't anymore.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>ezstepper selector switch number to send command to</td>
<td>None</td>
</tr>
<tr>
<td>ticks</td>
<td>None</td>
<td>encoder ticks to move on each trial while searching for hard stop</td>
<td>None</td>
</tr>
<tr>
<td>speed</td>
<td>None</td>
<td>encoder ticks per second</td>
<td>None</td>
</tr>
<tr>
<td>hold_current (optional)</td>
<td>None</td>
<td>target current, % of 2 A limit for motor when stationary</td>
<td>None</td>
</tr>
<tr>
<td>move_current (optional)</td>
<td>None</td>
<td>target current, % of 2 A limit for motor when moving</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>prev_ticks</td>
<td>The last encoder position before the hard stop was hit</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">bump_hard_stop</span><span class="p">(</span><span class="nx">ser</span><span class="p">:</span><span class="w"> </span><span class="nx">StepperSerial</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">:</span><span class="w"> </span><span class="nx">int</span><span class="p">,</span><span class="w"> </span><span class="nx">ticks</span><span class="p">:</span><span class="w"> </span><span class="nx">int</span><span class="p">,</span><span class="w"> </span><span class="nx">speed</span><span class="p">:</span><span class="w"> </span><span class="nx">int</span><span class="p">,</span><span class="w"> </span><span class="nx">hold_current</span><span class="p">=</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="nx">move_current</span><span class="p">=</span><span class="mi">50</span><span class="p">):</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="nx">Run</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">motor</span><span class="w"> </span><span class="nx">backward</span><span class="w"> </span><span class="nx">until</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">can</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">anymore</span><span class="p">.</span>

<span class="w">    </span><span class="nx">Parameters</span>

<span class="w">    </span><span class="o">----------</span>

<span class="w">    </span><span class="nx">ser</span>

<span class="w">        </span><span class="nx">pyserial</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">from</span>

<span class="w">    </span><span class="nx">address</span>

<span class="w">        </span><span class="nx">ezstepper</span><span class="w"> </span><span class="nx">selector</span><span class="w"> </span><span class="nx">switch</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">to</span>

<span class="w">    </span><span class="nx">ticks</span>

<span class="w">        </span><span class="nx">encoder</span><span class="w"> </span><span class="nx">ticks</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">move</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">trial</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nx">searching</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">hard</span><span class="w"> </span><span class="nx">stop</span>

<span class="w">    </span><span class="nx">speed</span>

<span class="w">        </span><span class="nx">encoder</span><span class="w"> </span><span class="nx">ticks</span><span class="w"> </span><span class="nx">per</span><span class="w"> </span><span class="nx">second</span>

<span class="w">    </span><span class="nx">hold_current</span><span class="w"> </span><span class="p">(</span><span class="nx">optional</span><span class="p">)</span>

<span class="w">        </span><span class="nx">target</span><span class="w"> </span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">motor</span><span class="w"> </span><span class="nx">when</span><span class="w"> </span><span class="nx">stationary</span>

<span class="w">    </span><span class="nx">move_current</span><span class="w"> </span><span class="p">(</span><span class="nx">optional</span><span class="p">)</span>

<span class="w">        </span><span class="nx">target</span><span class="w"> </span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">motor</span><span class="w"> </span><span class="nx">when</span><span class="w"> </span><span class="nx">moving</span>

<span class="w">    </span><span class="nx">Returns</span>

<span class="w">    </span><span class="o">-------</span>

<span class="w">    </span><span class="nx">prev_ticks</span>

<span class="w">        </span><span class="nx">The</span><span class="w"> </span><span class="nx">last</span><span class="w"> </span><span class="nx">encoder</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">hard</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">hit</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="nx">max_tries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">may</span><span class="w"> </span><span class="nx">take</span><span class="w"> </span><span class="nx">several</span><span class="w"> </span><span class="nx">moves</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">hit</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">hard</span><span class="w"> </span><span class="nx">stop</span>

<span class="w">    </span><span class="nx">tries</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="nx">prev_ticks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">800000</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">more</span><span class="w"> </span><span class="nx">ticks</span><span class="w"> </span><span class="nx">than</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="nx">available</span><span class="w"> </span><span class="nx">cable</span>

<span class="w">    </span><span class="nx">curr_ticks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">prev_ticks</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="nx">curr_ticks</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">prev_ticks</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nx">tries</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">max_tries</span><span class="p">)):</span>

<span class="w">        </span><span class="nx">prev_ticks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">curr_ticks</span>

<span class="w">        </span><span class="nx">wait_for_ready</span><span class="p">(</span><span class="nx">ser</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">)</span>

<span class="w">        </span><span class="nx">resp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ezstepper_write</span><span class="p">(</span>

<span class="w">            </span><span class="nx">ser</span><span class="p">,</span>

<span class="w">            </span><span class="nx">address</span><span class="p">,</span>

<span class="w">            </span><span class="p">(</span>

<span class="w">                </span><span class="nx">f</span><span class="err">&#39;</span><span class="nx">m</span><span class="p">{</span><span class="nx">move_current</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>

<span class="w">                </span><span class="nx">f</span><span class="err">&#39;</span><span class="nx">h</span><span class="p">{</span><span class="nx">hold_current</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>

<span class="w">                </span><span class="nx">f</span><span class="err">&#39;</span><span class="nx">V</span><span class="p">{</span><span class="nx">speed</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>

<span class="w">                </span><span class="nx">f</span><span class="err">&#39;</span><span class="nx">D</span><span class="p">{</span><span class="nx">ticks</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>

<span class="w">                </span><span class="err">&#39;</span><span class="nx">R</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="nx">curr_ticks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">get_encoder_pos</span><span class="p">(</span><span class="nx">ser</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">)</span>

<span class="w">        </span><span class="nx">tries</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">prev_ticks</span>
</code></pre></div>

</details>
<h3 id="ezstepper_check_ready">ezstepper_check_ready</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_check_ready</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>The EZStepper is ready to accept a new command if the ready bit is set. </p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, after throwing away garbage bytes</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>True if ready bit is set</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    The EZStepper is ready to accept a new command if the ready bit is set.</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    resp</span>

<span class="s1">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    bool</span>

<span class="s1">        True if ready bit is set</span>

<span class="s1">    &#39;&#39;&#39;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bool</span><span class="p">(</span><span class="n">resp</span><span class="o">[</span><span class="n">IDX_READY_BIT</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">b00100000</span><span class="p">)</span>
</code></pre></div>

</details>
<h3 id="ezstepper_check_status">ezstepper_check_status</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_check_status</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>Compare the status byte from the EZStepper to some common error codes.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, after throwing away garbage bytes</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>status_good</td>
<td>bool, True if response is nonempty and no unusual status byte patterns found</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="err">:</span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Compare the status byte from the EZStepper to some common error codes.</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    resp</span>

<span class="s1">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    status_good</span>

<span class="s1">        bool, True if response is nonempty and no unusual status byte patterns found</span>

<span class="s1">    &#39;&#39;&#39;</span>

<span class="w">    </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nl">resp</span><span class="p">:</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="nl">code</span><span class="p">:</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">EZStepper</span><span class="w"> </span><span class="n">docs</span>

<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resp</span><span class="o">[</span><span class="n">IDX_STATUS_BYTE</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">b00001111</span>

<span class="w">    </span><span class="k">else</span><span class="err">:</span>

<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="s1">&#39;&#39;</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Bad command error (illegal command was sent)&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Communications Error (Internal communications error)&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overload error (Physical system could not keep up with commanded position)&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Move not allowed&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Command overflow (unit was already executing a command when another command was received)&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">b&#39;&#39;, 0, 2, 9, 11, 15</span><span class="o">]</span><span class="err">:</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Unrecognized error code {status}. Consult EZStepper documentation.&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">status_good</span>
</code></pre></div>

</details>
<h3 id="ezstepper_write">ezstepper_write</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_write</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span> <span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span><span class="p">,</span>
    <span class="n">command_str</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span>
</code></pre></div>

<p>Builds a serial command to send to EZStepper(s), checks status bytes in</p>
<p>response, and returns response bytes.</p>
<div class="codehilite"><pre><span></span><code><span class="gh">Parameters</span>
<span class="gh">----------</span>
ser
    pyserial instance, the port to send bytes over from
address
    str, address of ezstepper
command_str
    string, chars to send over EZStepper bus

<span class="gh">Returns</span>
<span class="gh">-------</span>
resp
    bytes, serial response from EZStepper

Example:

<span class="s">```</span>
<span class="s">ezstepper.write(ser, 1, &#39;A1000R</span>
</code></pre></div>

<p>')
    ezstepper.write(ser, '<em>', 'A12000
')
    ezstepper.write(ser, '</em>', 'R
')
    ```</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">ezstepper_write</span><span class="p">(</span><span class="nx">ser</span><span class="p">:</span><span class="w"> </span><span class="nx">StepperSerial</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">command_str</span><span class="p">:</span><span class="w"> </span><span class="nx">str</span><span class="p">):</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="nx">Builds</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">serial</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">EZStepper</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span><span class="w"> </span><span class="nx">checks</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="k">in</span>

<span class="w">    </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span>

<span class="w">    </span><span class="nx">Parameters</span>

<span class="w">    </span><span class="o">----------</span>

<span class="w">    </span><span class="nx">ser</span>

<span class="w">        </span><span class="nx">pyserial</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">from</span>

<span class="w">    </span><span class="nx">address</span>

<span class="w">        </span><span class="nx">str</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">ezstepper</span>

<span class="w">    </span><span class="nx">command_str</span>

<span class="w">        </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">chars</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">send</span><span class="w"> </span><span class="nx">over</span><span class="w"> </span><span class="nx">EZStepper</span><span class="w"> </span><span class="nx">bus</span>

<span class="w">    </span><span class="nx">Returns</span>

<span class="w">    </span><span class="o">-------</span>

<span class="w">    </span><span class="nx">resp</span>

<span class="w">        </span><span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">serial</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">EZStepper</span>

<span class="w">    </span><span class="nx">Example</span><span class="p">:</span>

<span class="w">    </span><span class="err">```</span>

<span class="w">    </span><span class="nx">ezstepper</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ser</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">A1000R</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">ezstepper</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ser</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">A12000</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">ezstepper</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">ser</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">R</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="err">```</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="nx">ser</span><span class="p">.</span><span class="nx">write</span><span class="p">((</span><span class="nx">f</span><span class="err">&#39;</span><span class="o">/</span><span class="p">{</span><span class="nx">address</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">command_str</span><span class="p">).</span><span class="nx">encode</span><span class="p">())</span>

<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">EZStepper</span><span class="w"> </span><span class="nx">cmd</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="nx">format</span><span class="p">((</span><span class="nx">f</span><span class="err">&#39;</span><span class="o">/</span><span class="p">{</span><span class="nx">address</span><span class="p">}</span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">command_str</span><span class="p">).</span><span class="nx">rstrip</span><span class="p">(</span><span class="err">&#39;\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span><span class="p">)))</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">anticipate</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="s">&quot;all call&quot;</span><span class="w"> </span><span class="nx">commands</span><span class="p">.</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="sc">&#39;_&#39;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">:</span>

<span class="w">        </span><span class="nx">resp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span><span class="err">&#39;&#39;</span>

<span class="w">    </span><span class="k">else</span><span class="p">:</span>

<span class="w">        </span><span class="nx">resp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">look_for_response</span><span class="p">(</span><span class="nx">ser</span><span class="p">.</span><span class="nx">readline</span><span class="p">())</span>

<span class="w">        </span><span class="nx">status_good</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ezstepper_check_status</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>

<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">EZStepper</span><span class="w"> </span><span class="nx">response</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">rstrip</span><span class="p">(</span><span class="nx">b</span><span class="err">&#39;\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="err">&#39;</span><span class="p">)))</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">resp</span>
</code></pre></div>

</details>
<h3 id="get_encoder_pos">get_encoder_pos</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span> <span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span>
<span class="p">)</span>
</code></pre></div>

<p>Gets EZStepper's encoder counts in terms of ticks. It is critical for</p>
<p>accurate operation that this call succeeds, so the program will exit
if it fails.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>str, address of ezstepper</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ticks</td>
<td>Number of encoder ticks counted by encoder. A 10000 line encoder<br>has 4 * 10000 = 40000 lines per revolution.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span><span class="s s-Atom">ser</span><span class="p">:</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="s s-Atom">address</span><span class="p">)</span><span class="o">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Gets EZStepper&#39;s</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">counts</span> <span class="s s-Atom">in</span> <span class="s s-Atom">terms</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ticks</span><span class="p">.</span> <span class="nv">It</span> <span class="o">is</span> <span class="s s-Atom">critical</span> <span class="s s-Atom">for</span>

    <span class="s s-Atom">accurate</span> <span class="s s-Atom">operation</span> <span class="s s-Atom">that</span> <span class="s s-Atom">this</span> <span class="s s-Atom">call</span> <span class="s s-Atom">succeeds</span><span class="p">,</span> <span class="s s-Atom">so</span> <span class="s s-Atom">the</span> <span class="s s-Atom">program</span> <span class="s s-Atom">will</span> <span class="s s-Atom">exit</span>

    <span class="s s-Atom">if</span> <span class="s s-Atom">it</span> <span class="s s-Atom">fails</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">address</span>

        <span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">address</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ezstepper</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">ticks</span>

        <span class="nv">Number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">counted</span> <span class="s s-Atom">by</span> <span class="s s-Atom">encoder</span><span class="p">.</span> <span class="nv">A</span> <span class="mi">10000</span> <span class="s s-Atom">line</span> <span class="s s-Atom">encoder</span>

        <span class="s s-Atom">has</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">=</span> <span class="mi">40000</span> <span class="s s-Atom">lines</span> <span class="s s-Atom">per</span> <span class="s s-Atom">revolution</span><span class="p">.</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    ticks = 0</span>

<span class="s s-Atom">    resp = ezstepper_write(ser, address, &#39;</span><span class="nb">?</span><span class="mi">8</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    retries = 10</span>

<span class="s s-Atom">    while not resp and retries &gt; 0:</span>

<span class="s s-Atom">        resp = ezstepper_write(ser, address, &#39;</span><span class="nb">?</span><span class="mi">8</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">        retries -= 1</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">was</span> <span class="s s-Atom">slow</span> <span class="s s-Atom">to</span> <span class="s s-Atom">respond</span><span class="p">.</span> <span class="nv">Retrying</span><span class="p">,</span> <span class="p">{</span><span class="s s-Atom">retries</span><span class="p">}</span> <span class="s s-Atom">remaining</span><span class="p">.</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    retries = 10</span>

<span class="s s-Atom">    while not ezstepper_check_status(resp) and retries &gt; 0:</span>

<span class="s s-Atom">        retries -= 1</span>

<span class="s s-Atom">        logger.warning(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">status</span> <span class="s s-Atom">was</span> <span class="s s-Atom">bad</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}.</span> <span class="nv">Retrying</span><span class="p">,</span> <span class="p">{</span><span class="s s-Atom">retries</span><span class="p">}</span> <span class="s s-Atom">remaining</span><span class="p">.</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">    if retries &lt; 0:</span>

<span class="s s-Atom">        logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">status</span> <span class="s s-Atom">bad</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}.</span> <span class="nv">Is</span> <span class="nv">EZStepper</span><span class="o">/</span><span class="s s-Atom">encoder</span> <span class="s s-Atom">connected</span><span class="nb">?</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        sys.exit(1)</span>

<span class="s s-Atom">    else:</span>

<span class="s s-Atom">        payload = resp[IDX_STATUS_BYTE+1:-NUM_TRAILING_BYTES]</span>

<span class="s s-Atom">        logger.debug(f&#39;</span><span class="nv">Encoder</span> <span class="s s-Atom">reading</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">payload</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        if payload:</span>

<span class="s s-Atom">            ticks = int(payload.decode(&#39;utf</span><span class="o">-</span><span class="mi">8</span><span class="s s-Atom">&#39;))</span>

<span class="s s-Atom">        else:</span>

<span class="s s-Atom">            logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">didn\&#39;t respond.&#39;</span><span class="p">)</span>

            <span class="s s-Atom">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="s s-Atom">return</span> <span class="s s-Atom">ticks</span>
</code></pre></div>

</details>
<h3 id="look_for_response">look_for_response</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">look_for_response</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>Responses addressed to the controller node begin with /0, with possible</p>
<p>junk before.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, straight out of serial</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>Any bytes after /0</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">look_for_response</span><span class="p">(</span><span class="nx">resp</span><span class="p">):</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="nx">Responses</span><span class="w"> </span><span class="nx">addressed</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="nx">begin</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">possible</span>

<span class="w">    </span><span class="nx">junk</span><span class="w"> </span><span class="nx">before</span><span class="p">.</span>

<span class="w">    </span><span class="nx">Parameters</span>

<span class="w">    </span><span class="o">----------</span>

<span class="w">    </span><span class="nx">resp</span>

<span class="w">        </span><span class="nx">bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">EZStepper</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="nx">straight</span><span class="w"> </span><span class="nx">out</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">serial</span>

<span class="w">    </span><span class="nx">Returns</span>

<span class="w">    </span><span class="o">-------</span>

<span class="w">    </span><span class="nx">resp</span>

<span class="w">        </span><span class="nx">Any</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="o">/</span><span class="mi">0</span>

<span class="w">    </span><span class="err">&#39;&#39;&#39;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="err">&#39;</span><span class="o">/</span><span class="mi">0</span><span class="err">&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">resp</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="err">&#39;\</span><span class="nx">x03</span><span class="err">&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">resp</span><span class="p">):</span>

<span class="w">        </span><span class="nx">resp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">resp</span><span class="p">[</span><span class="nx">resp</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">b</span><span class="err">&#39;</span><span class="o">/</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">):]</span>

<span class="w">    </span><span class="k">else</span><span class="p">:</span>

<span class="w">        </span><span class="nx">resp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span><span class="err">&#39;&#39;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">resp</span>
</code></pre></div>

</details>
<h3 id="send_hawkeye_byte">send_hawkeye_byte</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">send_hawkeye_byte</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span> <span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span>
</code></pre></div>

<p>Control three groups of Hawkeye IR sources on the raft. Each of the first</p>
<p>three bits of the <code>data</code> byte turns on one of the three available groups of
Hawkeyes on the raft: center, inner ring, and outer ring.
The byte is sent over serial to a microcontroller, which forwards the byte
to a shift register on the raft via SPI.</p>
<p>For example:
- data = 1 -&gt; 001 -&gt; center Hawkeye only
- data = 2 -&gt; 010 -&gt; inner ring only
- data = 3 -&gt; 011 -&gt; center and inner
- data = 7 -&gt; 111 -&gt; center, inner, outer</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send byte over from</td>
<td>None</td>
</tr>
<tr>
<td>data (int)</td>
<td>None</td>
<td>integer whose binary representation will appear at the shift register<br>outputs on the raft</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">send_hawkeye_byte</span><span class="p">(</span><span class="n">ser</span><span class="o">:</span><span class="w"> </span><span class="n">HawkeyeSerial</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="o">:</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="o">:</span>

<span class="w">    </span><span class="s1">&#39;</span><span class="se">&#39;&#39;</span>

<span class="s1">    Control three groups of Hawkeye IR sources on the raft. Each of the first</span>

<span class="s1">    three bits of the `data` byte turns on one of the three available groups of</span>

<span class="s1">    Hawkeyes on the raft: center, inner ring, and outer ring.</span>

<span class="s1">    The byte is sent over serial to a microcontroller, which forwards the byte</span>

<span class="s1">    to a shift register on the raft via SPI.</span>

<span class="s1">    For example:</span>

<span class="s1">    - data = 1 -&gt; 001 -&gt; center Hawkeye only</span>

<span class="s1">    - data = 2 -&gt; 010 -&gt; inner ring only</span>

<span class="s1">    - data = 3 -&gt; 011 -&gt; center and inner</span>

<span class="s1">    - data = 7 -&gt; 111 -&gt; center, inner, outer</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    ser</span>

<span class="s1">        pyserial instance, the port to send byte over from</span>

<span class="s1">    data (int)</span>

<span class="s1">        integer whose binary representation will appear at the shift register</span>

<span class="s1">        outputs on the raft</span>

<span class="s1">    </span><span class="se">&#39;&#39;</span><span class="s1">&#39;</span>

<span class="w">    </span><span class="n">assert</span><span class="w"> </span><span class="n">isinstance</span><span class="p">(</span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">255</span><span class="o">:</span>

<span class="w">        </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span>

<span class="w">        </span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="n">ser</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{data}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>

<span class="w">    </span><span class="k">return</span>
</code></pre></div>

</details>
<h3 id="wait_for_ready">wait_for_ready</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">wait_for_ready</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">,</span>
    <span class="n">address</span><span class="p">,</span>
    <span class="n">ready_timeout</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>str, address of ezstepper</td>
<td>None</td>
</tr>
<tr>
<td>ready_timeout (optional)</td>
<td>None</td>
<td>float, time in seconds before deciding the stepper is unresponsive</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">wait_for_ready</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">ready_timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        str, address of ezstepper</span>

<span class="sd">    ready_timeout (optional)</span>

<span class="sd">        float, time in seconds before deciding the stepper is unresponsive</span>

<span class="sd">    &#39;&#39;&#39;</span>

<span class="w">    </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">b</span><span class="s1">&#39;&#39;</span>

<span class="w">    </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">False</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">address</span><span class="p">:</span>

<span class="w">        </span><span class="c1"># only send a new command if ezstepper not busy</span>

<span class="w">        </span><span class="n">start_busywait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="w">        </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/{address}Q</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_busywait</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ready_timeout</span><span class="p">:</span>

<span class="w">            </span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

<span class="w">            </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">line</span><span class="p">:</span>

<span class="w">                </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">look_for_response</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Ready response: {resp}&#39;</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">resp</span><span class="p">:</span>

<span class="w">                </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

<span class="w">        </span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Waited {time.time() - start_busywait:.4f} sec for ready signal&#39;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">ready</span><span class="p">:</span>

<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;EZStepper {address} was not ready in allotted time {ready_timeout} sec&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="commandbuffer">CommandBuffer</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CommandBuffer</span><span class="p">(</span>
    <span class="n">addresses</span>
<span class="p">)</span>
</code></pre></div>

<p>Handles building a string of commands to send over serial.</p>
<p>Continuous movement requires a sequence of carefully orchestrated
absolute angle and velocity commands. In order to avoid serial transfer/
ready waiting overhead, it's most efficient to send a long sequence to each
stepper controller, and then run them all together.</p>
<p>All methods deal in strings, not byte objects.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nl">CommandBuffer</span><span class="p">:</span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Handles building a string of commands to send over serial.</span>

<span class="s1">    Continuous movement requires a sequence of carefully orchestrated</span>

<span class="s1">    absolute angle and velocity commands. In order to avoid serial transfer/</span>

<span class="s1">    ready waiting overhead, it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">efficient</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="k">sequence</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">each</span>

<span class="w">    </span><span class="n">stepper</span><span class="w"> </span><span class="n">controller</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">together</span><span class="p">.</span>

<span class="w">    </span><span class="ow">All</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="n">deal</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">strings</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">objects</span><span class="p">.</span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    def __init__(self, addresses):</span>

<span class="s1">        &#39;&#39;&#39;</span><span class="n">Addresses</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">EZStepper</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="n">addresses</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="w"> </span><span class="o">[</span><span class="n">2,1,3,4</span><span class="o">]</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">        self.buffer_map = {address : &#39;&#39; for address in addresses}</span>

<span class="s1">    def put(self, address, command_str):</span>

<span class="s1">        self.buffer_map[address] += command_str</span>

<span class="s1">        logger.debug(f&#39;</span><span class="nl">CommandBuffer</span><span class="p">:</span><span class="n">put</span><span class="p">()</span><span class="w"> </span><span class="err">{</span><span class="n">address</span><span class="err">}:</span><span class="w"> </span><span class="err">{</span><span class="n">command_str</span><span class="err">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">{</span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span><span class="err">}</span><span class="s1">&#39;)</span>

<span class="s1">    def empty(self, address):</span>

<span class="s1">        &#39;&#39;&#39;</span><span class="k">Use</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">sending</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">        self.buffer_map[address] = &#39;&#39;</span>

<span class="s1">    def terminate(self, address):</span>

<span class="s1">        &#39;&#39;&#39;</span><span class="k">Use</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">sending</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">        self.buffer_map[address] += &#39;</span><span class="err">\</span><span class="n">r</span><span class="err">\</span><span class="n">n</span><span class="err">&#39;</span>

<span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span>
</code></pre></div>

</details>
<hr />
<h4 id="methods">Methods</h4>
<h4 id="empty">empty</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">empty</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">address</span>
<span class="p">)</span>
</code></pre></div>

<p>Use after sending</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="s1">&#39;&#39;&#39;Use after sending&#39;&#39;&#39;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
</code></pre></div>

</details>
<h4 id="get">get</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">address</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span>
</code></pre></div>

</details>
<h4 id="put">put</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">address</span><span class="p">,</span>
    <span class="n">command_str</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">put</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">command_str</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">command_str</span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;CommandBuffer:put() {address}: {command_str} -&gt; {self.buffer_map[address]}&#39;</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="terminate">terminate</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">address</span>
<span class="p">)</span>
</code></pre></div>

<p>Use before sending</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="k">terminate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="s1">&#39;&#39;&#39;Use before sending&#39;&#39;&#39;</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">buffer_map</span><span class="o">[</span><span class="n">address</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;\r\n&#39;</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
<footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../executive/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Executive" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Executive
              </div>
            </div>
          </a>
        
        
          
          <a href="../hw_context/" class="md-footer__link md-footer__link--next" aria-label="Next: Hw Context" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Hw Context
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
            
            Powered by
            <a href="http://timothycrosley.github.io/portray">portray.</a>
            You too can
            <a href="http://timothycrosley.github.io/portray">
              portray</a>
            your Python project well using automatic documentation.
          </div>
        
      </div>
    </div>
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>