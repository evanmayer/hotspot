
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.0">
    
    
      
        <title>Hardware - hotspot</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-hotspothardware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="hotspot" class="md-header__button md-logo" aria-label="hotspot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            hotspot
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hardware
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/evanmayer/hotspot/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotspot
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="hotspot" class="md-nav__button md-logo" aria-label="hotspot" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    hotspot
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/evanmayer/hotspot/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hotspot
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../HOWTO/" class="md-nav__link">
        Howto
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Hotspot
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Hotspot" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Hotspot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../algorithm/" class="md-nav__link">
        Algorithm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        Constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../executive/" class="md-nav__link">
        Executive
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Hardware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Hardware
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all_steppers_ez" class="md-nav__link">
    all_steppers_ez
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bump_hard_stop" class="md-nav__link">
    bump_hard_stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_ready" class="md-nav__link">
    ezstepper_check_ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_status" class="md-nav__link">
    ezstepper_check_status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_write" class="md-nav__link">
    ezstepper_write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_encoder_pos" class="md-nav__link">
    get_encoder_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look_for_response" class="md-nav__link">
    look_for_response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_hawkeye_byte" class="md-nav__link">
    send_hawkeye_byte
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wait_for_ready" class="md-nav__link">
    wait_for_ready
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hw_context/" class="md-nav__link">
        Hw Context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../telemetry/" class="md-nav__link">
        Telemetry
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#all_steppers_ez" class="md-nav__link">
    all_steppers_ez
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bump_hard_stop" class="md-nav__link">
    bump_hard_stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_ready" class="md-nav__link">
    ezstepper_check_ready
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_check_status" class="md-nav__link">
    ezstepper_check_status
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ezstepper_write" class="md-nav__link">
    ezstepper_write
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_encoder_pos" class="md-nav__link">
    get_encoder_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look_for_response" class="md-nav__link">
    look_for_response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send_hawkeye_byte" class="md-nav__link">
    send_hawkeye_byte
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wait_for_ready" class="md-nav__link">
    wait_for_ready
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/evanmayer/hotspot/edit/main/reference/hotspot/hardware.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="module-hotspothardware">Module hotspot.hardware</h1>
<p>None</p>
<p>None</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="c1"># This file defines the interfaces used to command the hardware.</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">hotspot.constants</span> <span class="k">as</span> <span class="nn">const</span>

<span class="kn">from</span> <span class="nn">hotspot.hw_context</span> <span class="kn">import</span> <span class="n">StepperSerial</span><span class="p">,</span> <span class="n">HawkeyeSerial</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">IDX_READY_BIT</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">IDX_STATUS_BYTE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">NUM_TRAILING_BYTES</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Conventions:</span>

<span class="c1"># - positive steps/angular rates spin the motor shaft clockwise (CW) when</span>

<span class="c1">#   viewed from the rear.</span>

<span class="c1"># - negative steps/angular rates spin the motor shaft counterclockwise (CCW)</span>

<span class="c1">#   when viewed from the rear.</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="c1"># Stepper functions</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Compare the status byte from the EZStepper to some common error codes.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    resp</span>

<span class="sd">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    status_good</span>

<span class="sd">        bool, True if response is nonempty and no unusual status byte patterns found</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">status_good</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>

        <span class="c1"># bits 0-3 form an error code: see EZStepper docs</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">IDX_STATUS_BYTE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mb">0b00001111</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">status</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

        <span class="n">status_good</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="mi">9</span> <span class="o">==</span> <span class="n">status</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overload Error (Physical system could not keep up with commanded position)&#39;</span><span class="p">)</span>

        <span class="n">status_good</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="mi">15</span> <span class="o">==</span> <span class="n">status</span><span class="p">:</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Command overflow (unit was already executing a command when another command was received)&#39;</span><span class="p">)</span>

        <span class="n">status_good</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="p">((</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">9</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">15</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized error code </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">. Consult EZStepper documentation.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">status_good</span>

<span class="k">def</span> <span class="nf">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    The EZStepper is ready to accept a new command if the ready bit is set.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    resp</span>

<span class="sd">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    bool</span>

<span class="sd">        True if ready bit is set</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="n">IDX_READY_BIT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mb">0b00100000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">wait_for_ready</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ready_timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        str, address of ezstepper</span>

<span class="sd">    ready_timeout (optional)</span>

<span class="sd">        float, time in seconds before deciding the stepper is unresponsive</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="o">!=</span> <span class="n">address</span><span class="p">:</span>

        <span class="c1"># only send a new command if ezstepper not busy</span>

        <span class="n">start_busywait</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">ready</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_busywait</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ready_timeout</span><span class="p">:</span>

            <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1">Q</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">look_for_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>

                <span class="n">ready</span> <span class="o">=</span> <span class="n">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waited </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_busywait</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> sec for ready signal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;EZStepper </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1"> was not ready in allotted time </span><span class="si">{</span><span class="n">ready_timeout</span><span class="si">}</span><span class="s1"> sec&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">look_for_response</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Responses addressed to the controller node begin with /0, with possible</span>

<span class="sd">    junk before.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    resp</span>

<span class="sd">        bytes, EZStepper response, straight out of serial</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    resp</span>

<span class="sd">        Any bytes after /0</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;/0&#39;</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">resp</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/0&#39;</span><span class="p">):]</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">resp</span>

<span class="k">def</span> <span class="nf">ezstepper_write</span><span class="p">(</span><span class="n">ser</span><span class="p">:</span> <span class="n">StepperSerial</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">command_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Builds a serial command to send to EZStepper(s), checks status bytes in</span>

<span class="sd">    response, and returns response bytes.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        str, address of ezstepper</span>

<span class="sd">    command_str</span>

<span class="sd">        string, chars to send over EZStepper bus</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    resp</span>

<span class="sd">        bytes, serial response from EZStepper</span>

<span class="sd">    Example:</span>

<span class="sd">    ```</span>

<span class="sd">    ezstepper.write(ser, 1, &#39;A1000R\r\n&#39;)</span>

<span class="sd">    ezstepper.write(ser, &#39;_&#39;, &#39;A12000\r\n&#39;)</span>

<span class="sd">    ezstepper.write(ser, &#39;_&#39;, &#39;R\r\n&#39;)</span>

<span class="sd">    ```</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wait_for_ready</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">command_str</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;EZStepper cmd: </span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">command_str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)))</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">look_for_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

    <span class="n">status_good</span> <span class="o">=</span> <span class="n">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;EZStepper response: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">resp</span>

<span class="k">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span><span class="n">ser</span><span class="p">:</span> <span class="n">StepperSerial</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Gets EZStepper&#39;s encoder counts in terms of ticks. It is critical for</span>

<span class="sd">    accurate operation that this call succeeds, so the program will exit</span>

<span class="sd">    if it fails.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        str, address of ezstepper</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    ticks</span>

<span class="sd">        Number of encoder ticks counted by encoder. A 10000 line encoder</span>

<span class="sd">        has 4 * 10000 = 40000 lines per revolution.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ticks</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">ezstepper_write</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="s1">&#39;?8R</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Encoder </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1"> status bad: </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">. Is EZStepper/encoder connected?&#39;</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="n">IDX_STATUS_BYTE</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">NUM_TRAILING_BYTES</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Encoder reading: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>

            <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Encoder </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1"> didn</span><span class="se">\&#39;</span><span class="s1">t respond.&#39;</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ticks</span>

<span class="k">def</span> <span class="nf">bump_hard_stop</span><span class="p">(</span><span class="n">ser</span><span class="p">:</span> <span class="n">StepperSerial</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ticks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">speed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hold_current</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">move_current</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Run the motor backward until it can&#39;t anymore.</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        ezstepper selector switch number to send command to</span>

<span class="sd">    ticks</span>

<span class="sd">        encoder ticks to move on each trial while searching for hard stop</span>

<span class="sd">    speed</span>

<span class="sd">        encoder ticks per second</span>

<span class="sd">    hold_current (optional)</span>

<span class="sd">        target current, % of 2 A limit for motor when stationary</span>

<span class="sd">    move_current (optional)</span>

<span class="sd">        target current, % of 2 A limit for motor when moving</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    prev_ticks</span>

<span class="sd">        The last encoder position before the hard stop was hit</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># may take several moves to hit a hard stop</span>

    <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">prev_ticks</span> <span class="o">=</span> <span class="mi">800000</span> <span class="c1"># more ticks than we have total available cable</span>

    <span class="n">curr_ticks</span> <span class="o">=</span> <span class="n">prev_ticks</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">curr_ticks</span> <span class="o">&lt;</span> <span class="n">prev_ticks</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">)):</span>

        <span class="n">prev_ticks</span> <span class="o">=</span> <span class="n">curr_ticks</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">ezstepper_write</span><span class="p">(</span>

            <span class="n">ser</span><span class="p">,</span>

            <span class="n">address</span><span class="p">,</span>

            <span class="p">(</span>

                <span class="sa">f</span><span class="s1">&#39;m</span><span class="si">{</span><span class="n">move_current</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">hold_current</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="sa">f</span><span class="s1">&#39;V</span><span class="si">{</span><span class="n">speed</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="sa">f</span><span class="s1">&#39;D</span><span class="si">{</span><span class="n">ticks</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="s1">&#39;R</span><span class="se">\r\n</span><span class="s1">&#39;</span>

            <span class="p">)</span>

        <span class="p">)</span>

        <span class="n">curr_ticks</span> <span class="o">=</span> <span class="n">get_encoder_pos</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

        <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">prev_ticks</span>

<span class="k">def</span> <span class="nf">all_steppers_ez</span><span class="p">(</span><span class="n">ser</span><span class="p">:</span> <span class="n">StepperSerial</span><span class="p">,</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">radians</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Send serial commands to AllMotion EZHR17EN driver boards.</span>

<span class="sd">    Driver boards should already be in position-correction mode, so will take</span>

<span class="sd">    encoder ticks as commands. The driver boards handle achieving the requested</span>

<span class="sd">    absolute position.</span>

<span class="sd">    Commands in radians are converted to encoder ticks and sent to driver</span>

<span class="sd">    boards in order, based on their addresses [1,2,3,4].</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    addresses</span>

<span class="sd">        iterable of addresses e.g. [1,2,3,4] to route commands to</span>

<span class="sd">    radians</span>

<span class="sd">        iterable of signed angle to move each stepper to (radians)</span>

<span class="sd">    run (optional)</span>

<span class="sd">        If True, execute EZStepper command buffer after adding to it.</span>

<span class="sd">    Returns</span>

<span class="sd">    -------</span>

<span class="sd">    ticks_to_go</span>

<span class="sd">        iterable of integers reporting the number of encoder ticks moved by</span>

<span class="sd">        each stepper</span>

<span class="sd">    err</span>

<span class="sd">        iterable of rounding errors incurred by converting radians to encoder</span>

<span class="sd">        ticks</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Get the current absolute encoder position</span>

    <span class="n">current_ticks_raw</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_encoder_pos</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">]</span>

    <span class="n">current_ticks</span> <span class="o">=</span> <span class="n">current_ticks_raw</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current encoder positions before move: </span><span class="si">{</span><span class="n">current_ticks</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get the final absolute position</span>

    <span class="n">radians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">(</span><span class="n">radians</span><span class="p">)</span>

    <span class="n">ticks_float</span> <span class="o">=</span> <span class="n">radians</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">DEG_PER_RAD</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">DEG_PER_STEP</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">STEP_PER_TICK</span>

    <span class="n">ticks_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">round</span><span class="p">(</span><span class="n">ticks_float</span><span class="p">)</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">ticks_to_go</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">round</span><span class="p">(</span><span class="n">ticks_float</span> <span class="o">-</span> <span class="n">current_ticks</span><span class="p">)</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">ticks_float</span> <span class="o">-</span> <span class="n">current_ticks</span><span class="p">)</span> <span class="o">-</span> <span class="n">ticks_to_go</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Commanded encoder positions: </span><span class="si">{</span><span class="n">ticks_int</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Delta encoder positions: </span><span class="si">{</span><span class="n">ticks_to_go</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">tick_int</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">tick_int</span> <span class="ow">in</span> <span class="n">ticks_int</span><span class="p">]):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Move command past hard stop detected: </span><span class="si">{</span><span class="n">addresses</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">ticks_int</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Set the velocity of each motor such that they arrive at the final</span>

    <span class="c1"># position at the same time.</span>

    <span class="c1"># The motor with the longest move moves at the maximum velocity.</span>

    <span class="n">max_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">))</span>

    <span class="n">t_move</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_ticks</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">MAX_SPEED_TICKS</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>

    <span class="n">vels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="kp">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">)</span> <span class="o">/</span> <span class="n">t_move</span><span class="p">)</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Motor speeds: </span><span class="si">{</span><span class="n">vels</span><span class="si">}</span><span class="s1"> ticks / sec&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">)):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ticks_to_go</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">vels</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>

            <span class="c1"># Set velocity and command absolute encoder ticks</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">ezstepper_write</span><span class="p">(</span>

                <span class="n">ser</span><span class="p">,</span>

                <span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>

                <span class="p">(</span>

                    <span class="sa">f</span><span class="s1">&#39;V</span><span class="si">{</span><span class="n">vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>

                    <span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">ticks_int</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

                  <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>

                <span class="p">)</span>

            <span class="p">)</span>

    <span class="c1"># Execute buffered move commands for all addresses</span>

    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>

        <span class="n">ezstepper_write</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;R</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ticks_to_go</span><span class="p">,</span> <span class="n">err</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="c1"># Hawkeye functions</span>

<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">send_hawkeye_byte</span><span class="p">(</span><span class="n">ser</span><span class="p">:</span> <span class="n">HawkeyeSerial</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Control three groups of Hawkeye IR sources on the raft. Each of the first</span>

<span class="sd">    three bits of the `data` byte turns on one of the three available groups of</span>

<span class="sd">    Hawkeyes on the raft: center, inner ring, and outer ring.</span>

<span class="sd">    The byte is sent over serial to a microcontroller, which forwards the byte</span>

<span class="sd">    to a shift register on the raft via SPI.</span>

<span class="sd">    For example:</span>

<span class="sd">    - data = 1 -&gt; 001 -&gt; center Hawkeye only</span>

<span class="sd">    - data = 2 -&gt; 010 -&gt; inner ring only</span>

<span class="sd">    - data = 3 -&gt; 011 -&gt; center and inner</span>

<span class="sd">    - data = 7 -&gt; 111 -&gt; center, inner, outer</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send byte over from</span>

<span class="sd">    data (int)</span>

<span class="sd">        integer whose binary representation will appear at the shift register</span>

<span class="sd">        outputs on the raft</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>

        <span class="n">data</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">return</span>
</code></pre></div>

</details>
<h2 id="variables">Variables</h2>
<div class="codehilite"><pre><span></span><code><span class="n">IDX_READY_BIT</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">IDX_STATUS_BYTE</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">NUM_TRAILING_BYTES</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">logger</span>
</code></pre></div>

<h2 id="functions">Functions</h2>
<h3 id="all_steppers_ez">all_steppers_ez</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">all_steppers_ez</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span><span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">addresses</span><span class="p">,</span>
    <span class="n">radians</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span>
    <span class="n">run</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</code></pre></div>

<p>Send serial commands to AllMotion EZHR17EN driver boards.</p>
<p>Driver boards should already be in position-correction mode, so will take
encoder ticks as commands. The driver boards handle achieving the requested
absolute position.
Commands in radians are converted to encoder ticks and sent to driver
boards in order, based on their addresses [1,2,3,4].</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>addresses</td>
<td>None</td>
<td>iterable of addresses e.g. [1,2,3,4] to route commands to</td>
<td>None</td>
</tr>
<tr>
<td>radians</td>
<td>None</td>
<td>iterable of signed angle to move each stepper to (radians)</td>
<td>None</td>
</tr>
<tr>
<td>run (optional)</td>
<td>None</td>
<td>If True, execute EZStepper command buffer after adding to it.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ticks_to_go</td>
<td>iterable of integers reporting the number of encoder ticks moved by</td>
</tr>
<tr>
<td>each stepper</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">all_steppers_ez</span><span class="p">(</span><span class="nl">ser</span><span class="p">:</span><span class="w"> </span><span class="n">StepperSerial</span><span class="p">,</span><span class="w"> </span><span class="n">addresses</span><span class="p">,</span><span class="w"> </span><span class="nf">radians</span><span class="err">:</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Send serial commands to AllMotion EZHR17EN driver boards.</span>

<span class="s1">    Driver boards should already be in position-correction mode, so will take</span>

<span class="s1">    encoder ticks as commands. The driver boards handle achieving the requested</span>

<span class="s1">    absolute position.</span>

<span class="s1">    Commands in radians are converted to encoder ticks and sent to driver</span>

<span class="s1">    boards in order, based on their addresses [1,2,3,4].</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    ser</span>

<span class="s1">        pyserial instance, the port to send bytes over from</span>

<span class="s1">    addresses</span>

<span class="s1">        iterable of addresses e.g. [1,2,3,4] to route commands to</span>

<span class="s1">    radians</span>

<span class="s1">        iterable of signed angle to move each stepper to (radians)</span>

<span class="s1">    run (optional)</span>

<span class="s1">        If True, execute EZStepper command buffer after adding to it.</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    ticks_to_go</span>

<span class="s1">        iterable of integers reporting the number of encoder ticks moved by</span>

<span class="s1">        each stepper</span>

<span class="s1">    err</span>

<span class="s1">        iterable of rounding errors incurred by converting radians to encoder</span>

<span class="s1">        ticks</span>

<span class="s1">    &#39;&#39;&#39;</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="k">position</span><span class="w"></span>

<span class="w">    </span><span class="n">current_ticks_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">get_encoder_pos(ser, address) for address in addresses</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="n">current_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_ticks_raw</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Current encoder positions before move: {current_ticks}&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Get</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">final</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="k">position</span><span class="w"></span>

<span class="w">    </span><span class="nf">radians</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="nf">radians</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">ticks_float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">radians</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">DEG_PER_RAD</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">DEG_PER_STEP</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">STEP_PER_TICK</span><span class="w"></span>

<span class="w">    </span><span class="n">ticks_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">ticks_float</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">ticks_to_go</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">ticks_float</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_ticks</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ticks_float</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_ticks</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ticks_to_go</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Commanded encoder positions: {ticks_int}&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Delta encoder positions: {ticks_to_go}&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">any</span><span class="p">(</span><span class="o">[</span><span class="n">tick_int &lt; 0 for tick_int in ticks_int</span><span class="o">]</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Move command past hard stop detected: {addresses} : {ticks_int}&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">they</span><span class="w"> </span><span class="n">arrive</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">final</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">position</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="nc">time</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">motor</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">longest</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">moves</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">velocity</span><span class="p">.</span><span class="w"></span>

<span class="w">    </span><span class="n">max_ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="n">t_move</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">max_ticks</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">const</span><span class="p">.</span><span class="n">MAX_SPEED_TICKS</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">vels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">t_move</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Motor speeds: {vels} ticks / sec&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ticks_to_go</span><span class="p">))</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ticks_to_go</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">vels</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">Set</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="k">absolute</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">ticks</span><span class="w"></span>

<span class="w">            </span><span class="n">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezstepper_write</span><span class="p">(</span><span class="w"></span>

<span class="w">                </span><span class="n">ser</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="n">addresses</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"></span>

<span class="w">                </span><span class="p">(</span><span class="w"></span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;V{vels[i]}&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;A{ticks_int[i]}&#39;</span><span class="w"></span>

<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;\r\n&#39;</span><span class="w"></span>

<span class="w">                </span><span class="p">)</span><span class="w"></span>

<span class="w">            </span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Execute</span><span class="w"> </span><span class="n">buffered</span><span class="w"> </span><span class="n">move</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">addresses</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nl">run</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">ezstepper_write</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;R\r\n&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ticks_to_go</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="bump_hard_stop">bump_hard_stop</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">bump_hard_stop</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span><span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">ticks</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">speed</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">hold_current</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">move_current</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>
</code></pre></div>

<p>Run the motor backward until it can't anymore.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>ezstepper selector switch number to send command to</td>
<td>None</td>
</tr>
<tr>
<td>ticks</td>
<td>None</td>
<td>encoder ticks to move on each trial while searching for hard stop</td>
<td>None</td>
</tr>
<tr>
<td>speed</td>
<td>None</td>
<td>encoder ticks per second</td>
<td>None</td>
</tr>
<tr>
<td>hold_current (optional)</td>
<td>None</td>
<td>target current, % of 2 A limit for motor when stationary</td>
<td>None</td>
</tr>
<tr>
<td>move_current (optional)</td>
<td>None</td>
<td>target current, % of 2 A limit for motor when moving</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>prev_ticks</td>
<td>The last encoder position before the hard stop was hit</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">bump_hard_stop</span><span class="ss">(</span><span class="nv">ser</span>: <span class="nv">StepperSerial</span>, <span class="nv">address</span>: <span class="nv">int</span>, <span class="nv">ticks</span>: <span class="nv">int</span>, <span class="nv">speed</span>: <span class="nv">int</span>, <span class="nv">hold_current</span><span class="o">=</span><span class="mi">50</span>, <span class="nv">move_current</span><span class="o">=</span><span class="mi">50</span><span class="ss">)</span>:

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="nv">Run</span> <span class="nv">the</span> <span class="nv">motor</span> <span class="nv">backward</span> <span class="k">until</span> <span class="nv">it</span> <span class="nv">can</span><span class="s1">&#39;</span><span class="s">t anymore.</span>

    <span class="nv">Parameters</span>

    <span class="o">----------</span>

    <span class="nv">ser</span>

        <span class="nv">pyserial</span> <span class="nv">instance</span>, <span class="nv">the</span> <span class="nv">port</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">bytes</span> <span class="nv">over</span> <span class="nv">from</span>

    <span class="nv">address</span>

        <span class="nv">ezstepper</span> <span class="nv">selector</span> <span class="nv">switch</span> <span class="nv">number</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">command</span> <span class="nv">to</span>

    <span class="nv">ticks</span>

        <span class="nv">encoder</span> <span class="nv">ticks</span> <span class="nv">to</span> <span class="nv">move</span> <span class="nv">on</span> <span class="nv">each</span> <span class="nv">trial</span> <span class="k">while</span> <span class="nv">searching</span> <span class="k">for</span> <span class="nv">hard</span> <span class="nv">stop</span>

    <span class="nv">speed</span>

        <span class="nv">encoder</span> <span class="nv">ticks</span> <span class="nv">per</span> <span class="nv">second</span>

    <span class="nv">hold_current</span> <span class="ss">(</span><span class="nv">optional</span><span class="ss">)</span>

        <span class="nv">target</span> <span class="nv">current</span>, <span class="o">%</span> <span class="nv">of</span> <span class="mi">2</span> <span class="nv">A</span> <span class="nv">limit</span> <span class="k">for</span> <span class="nv">motor</span> <span class="nv">when</span> <span class="nv">stationary</span>

    <span class="nv">move_current</span> <span class="ss">(</span><span class="nv">optional</span><span class="ss">)</span>

        <span class="nv">target</span> <span class="nv">current</span>, <span class="o">%</span> <span class="nv">of</span> <span class="mi">2</span> <span class="nv">A</span> <span class="nv">limit</span> <span class="k">for</span> <span class="nv">motor</span> <span class="nv">when</span> <span class="nv">moving</span>

    <span class="nv">Returns</span>

    <span class="o">-------</span>

    <span class="nv">prev_ticks</span>

        <span class="nv">The</span> <span class="nv">last</span> <span class="nv">encoder</span> <span class="nv">position</span> <span class="nv">before</span> <span class="nv">the</span> <span class="nv">hard</span> <span class="nv">stop</span> <span class="nv">was</span> <span class="nv">hit</span>

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="nv">max_tries</span> <span class="o">=</span> <span class="mi">10000</span> # <span class="nv">may</span> <span class="nv">take</span> <span class="nv">several</span> <span class="nv">moves</span> <span class="nv">to</span> <span class="nv">hit</span> <span class="nv">a</span> <span class="nv">hard</span> <span class="nv">stop</span>

    <span class="nv">tries</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nv">prev_ticks</span> <span class="o">=</span> <span class="mi">800000</span> # <span class="nv">more</span> <span class="nv">ticks</span> <span class="nv">than</span> <span class="nv">we</span> <span class="nv">have</span> <span class="nv">total</span> <span class="nv">available</span> <span class="nv">cable</span>

    <span class="nv">curr_ticks</span> <span class="o">=</span> <span class="nv">prev_ticks</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="ss">((</span><span class="nv">curr_ticks</span> <span class="o">&lt;</span> <span class="nv">prev_ticks</span><span class="ss">)</span> <span class="nv">and</span> <span class="ss">(</span><span class="nv">tries</span> <span class="o">&lt;</span> <span class="nv">max_tries</span><span class="ss">))</span>:

        <span class="nv">prev_ticks</span> <span class="o">=</span> <span class="nv">curr_ticks</span>

        <span class="nv">resp</span> <span class="o">=</span> <span class="nv">ezstepper_write</span><span class="ss">(</span>

            <span class="nv">ser</span>,

            <span class="nv">address</span>,

            <span class="ss">(</span>

                <span class="nv">f</span><span class="s1">&#39;</span><span class="s">m{move_current}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="nv">f</span><span class="s1">&#39;</span><span class="s">h{hold_current}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="nv">f</span><span class="s1">&#39;</span><span class="s">V{speed}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="nv">f</span><span class="s1">&#39;</span><span class="s">D{ticks}</span><span class="s1">&#39;</span> <span class="o">+</span>

                <span class="s1">&#39;</span><span class="s">R\r</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="ss">)</span>

        <span class="ss">)</span>

        <span class="nv">curr_ticks</span> <span class="o">=</span> <span class="nv">get_encoder_pos</span><span class="ss">(</span><span class="nv">ser</span>, <span class="nv">address</span><span class="ss">)</span>

        <span class="nv">tries</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nv">prev_ticks</span>
</code></pre></div>

</details>
<h3 id="ezstepper_check_ready">ezstepper_check_ready</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_check_ready</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>The EZStepper is ready to accept a new command if the ready bit is set. </p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, after throwing away garbage bytes</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>True if ready bit is set</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    The EZStepper is ready to accept a new command if the ready bit is set.</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    resp</span>

<span class="s1">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    bool</span>

<span class="s1">        True if ready bit is set</span>

<span class="s1">    &#39;&#39;&#39;</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bool</span><span class="p">(</span><span class="n">resp</span><span class="o">[</span><span class="n">IDX_READY_BIT</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">b00100000</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="ezstepper_check_status">ezstepper_check_status</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_check_status</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>Compare the status byte from the EZStepper to some common error codes.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, after throwing away garbage bytes</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>status_good</td>
<td>bool, True if response is nonempty and no unusual status byte patterns found</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">ezstepper_check_status</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    Compare the status byte from the EZStepper to some common error codes.</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    resp</span>

<span class="s1">        bytes, EZStepper response, after throwing away garbage bytes</span>

<span class="s1">    Returns</span>

<span class="s1">    -------</span>

<span class="s1">    status_good</span>

<span class="s1">        bool, True if response is nonempty and no unusual status byte patterns found</span>

<span class="s1">    &#39;&#39;&#39;</span><span class="w"></span>

<span class="w">    </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nl">resp</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">bits</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="nl">code</span><span class="p">:</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">EZStepper</span><span class="w"> </span><span class="n">docs</span><span class="w"></span>

<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resp</span><span class="o">[</span><span class="n">IDX_STATUS_BYTE</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">b00001111</span><span class="w"></span>

<span class="w">    </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="s1">&#39;&#39;</span><span class="w"></span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overload Error (Physical system could not keep up with commanded position)&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nl">status</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Command overflow (unit was already executing a command when another command was received)&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">status_good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">))</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Unrecognized error code {status}. Consult EZStepper documentation.&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">status_good</span><span class="w"></span>
</code></pre></div>

</details>
<h3 id="ezstepper_write">ezstepper_write</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">ezstepper_write</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span><span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span><span class="p">,</span>
    <span class="n">command_str</span><span class="p">:</span><span class="nb">str</span>
<span class="p">)</span>
</code></pre></div>

<p>Builds a serial command to send to EZStepper(s), checks status bytes in</p>
<p>response, and returns response bytes.</p>
<div class="codehilite"><pre><span></span><code><span class="gh">Parameters</span>
<span class="gh">----------</span>
ser
    pyserial instance, the port to send bytes over from
address
    str, address of ezstepper
command_str
    string, chars to send over EZStepper bus

<span class="gh">Returns</span>
<span class="gh">-------</span>
resp
    bytes, serial response from EZStepper

Example:

<span class="s">```</span>
<span class="s">ezstepper.write(ser, 1, &#39;A1000R</span>
</code></pre></div>

<p>')
    ezstepper.write(ser, '<em>', 'A12000
')
    ezstepper.write(ser, '</em>', 'R
')
    ```</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">ezstepper_write</span><span class="ss">(</span><span class="nv">ser</span>: <span class="nv">StepperSerial</span>, <span class="nv">address</span>, <span class="nv">command_str</span>: <span class="nv">str</span><span class="ss">)</span>:

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="nv">Builds</span> <span class="nv">a</span> <span class="nv">serial</span> <span class="nv">command</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">to</span> <span class="nv">EZStepper</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span>, <span class="nv">checks</span> <span class="nv">status</span> <span class="nv">bytes</span> <span class="nv">in</span>

    <span class="nv">response</span>, <span class="nv">and</span> <span class="nv">returns</span> <span class="nv">response</span> <span class="nv">bytes</span>.

    <span class="nv">Parameters</span>

    <span class="o">----------</span>

    <span class="nv">ser</span>

        <span class="nv">pyserial</span> <span class="nv">instance</span>, <span class="nv">the</span> <span class="nv">port</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">bytes</span> <span class="nv">over</span> <span class="nv">from</span>

    <span class="nv">address</span>

        <span class="nv">str</span>, <span class="nv">address</span> <span class="nv">of</span> <span class="nv">ezstepper</span>

    <span class="nv">command_str</span>

        <span class="nv">string</span>, <span class="nv">chars</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">over</span> <span class="nv">EZStepper</span> <span class="nv">bus</span>

    <span class="nv">Returns</span>

    <span class="o">-------</span>

    <span class="nv">resp</span>

        <span class="nv">bytes</span>, <span class="nv">serial</span> <span class="nv">response</span> <span class="nv">from</span> <span class="nv">EZStepper</span>

    <span class="nv">Example</span>:

    ```

    <span class="nv">ezstepper</span>.<span class="nv">write</span><span class="ss">(</span><span class="nv">ser</span>, <span class="mi">1</span>, <span class="s1">&#39;</span><span class="s">A1000R\r</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)</span>

    <span class="nv">ezstepper</span>.<span class="nv">write</span><span class="ss">(</span><span class="nv">ser</span>, <span class="s1">&#39;</span><span class="s">_</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">A12000\r</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)</span>

    <span class="nv">ezstepper</span>.<span class="nv">write</span><span class="ss">(</span><span class="nv">ser</span>, <span class="s1">&#39;</span><span class="s">_</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">R\r</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)</span>

    ```

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="nv">wait_for_ready</span><span class="ss">(</span><span class="nv">ser</span>, <span class="nv">address</span><span class="ss">)</span>

    <span class="nv">ser</span>.<span class="nv">write</span><span class="ss">((</span><span class="nv">f</span><span class="s1">&#39;</span><span class="s">/{address}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nv">command_str</span><span class="ss">)</span>.<span class="nv">encode</span><span class="ss">())</span>

    <span class="nv">logger</span>.<span class="nv">debug</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">EZStepper cmd: {}{}</span><span class="s1">&#39;</span>.<span class="nv">format</span><span class="ss">(</span><span class="nv">address</span>, <span class="nv">command_str</span>.<span class="nv">rstrip</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">\r</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)))</span>

    <span class="nv">resp</span> <span class="o">=</span> <span class="nv">look_for_response</span><span class="ss">(</span><span class="nv">ser</span>.<span class="nv">readline</span><span class="ss">())</span>

    <span class="nv">status_good</span> <span class="o">=</span> <span class="nv">ezstepper_check_status</span><span class="ss">(</span><span class="nv">resp</span><span class="ss">)</span>

    <span class="nv">logger</span>.<span class="nv">debug</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">EZStepper response: {}</span><span class="s1">&#39;</span>.<span class="nv">format</span><span class="ss">(</span><span class="nv">resp</span>.<span class="nv">rstrip</span><span class="ss">(</span><span class="nv">b</span><span class="s1">&#39;</span><span class="s">\r</span><span class="se">\n</span><span class="s1">&#39;</span><span class="ss">)))</span>

    <span class="k">return</span> <span class="nv">resp</span>
</code></pre></div>

</details>
<h3 id="get_encoder_pos">get_encoder_pos</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span><span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">address</span>
<span class="p">)</span>
</code></pre></div>

<p>Gets EZStepper's encoder counts in terms of ticks. It is critical for</p>
<p>accurate operation that this call succeeds, so the program will exit
if it fails.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>str, address of ezstepper</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ticks</td>
<td>Number of encoder ticks counted by encoder. A 10000 line encoder</td>
</tr>
<tr>
<td>has 4 * 10000 = 40000 lines per revolution.</td>
<td></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">def</span> <span class="nf">get_encoder_pos</span><span class="p">(</span><span class="nn">ser</span><span class="p">:</span> <span class="nv">StepperSerial</span><span class="p">,</span> <span class="s s-Atom">address</span><span class="p">)</span><span class="s s-Atom">:</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    Gets EZStepper&#39;s</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">counts</span> <span class="s s-Atom">in</span> <span class="s s-Atom">terms</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ticks</span><span class="p">.</span> <span class="nv">It</span> <span class="o">is</span> <span class="s s-Atom">critical</span> <span class="s s-Atom">for</span>

    <span class="s s-Atom">accurate</span> <span class="s s-Atom">operation</span> <span class="s s-Atom">that</span> <span class="s s-Atom">this</span> <span class="s s-Atom">call</span> <span class="s s-Atom">succeeds</span><span class="p">,</span> <span class="s s-Atom">so</span> <span class="s s-Atom">the</span> <span class="s s-Atom">program</span> <span class="s s-Atom">will</span> <span class="s s-Atom">exit</span>

    <span class="s s-Atom">if</span> <span class="s s-Atom">it</span> <span class="s s-Atom">fails</span><span class="p">.</span>

    <span class="nv">Parameters</span>

    <span class="s s-Atom">----------</span>

    <span class="s s-Atom">ser</span>

        <span class="s s-Atom">pyserial</span> <span class="s s-Atom">instance</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">port</span> <span class="s s-Atom">to</span> <span class="s s-Atom">send</span> <span class="s s-Atom">bytes</span> <span class="s s-Atom">over</span> <span class="s s-Atom">from</span>

    <span class="s s-Atom">address</span>

        <span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">address</span> <span class="s s-Atom">of</span> <span class="s s-Atom">ezstepper</span>

    <span class="nv">Returns</span>

    <span class="s s-Atom">-------</span>

    <span class="s s-Atom">ticks</span>

        <span class="nv">Number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">encoder</span> <span class="s s-Atom">ticks</span> <span class="s s-Atom">counted</span> <span class="s s-Atom">by</span> <span class="s s-Atom">encoder</span><span class="p">.</span> <span class="nv">A</span> <span class="mi">10000</span> <span class="s s-Atom">line</span> <span class="s s-Atom">encoder</span>

        <span class="s s-Atom">has</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">=</span> <span class="mi">40000</span> <span class="s s-Atom">lines</span> <span class="s s-Atom">per</span> <span class="s s-Atom">revolution</span><span class="p">.</span>

    <span class="s s-Atom">&#39;&#39;&#39;</span>

<span class="s s-Atom">    ticks = 0</span>

<span class="s s-Atom">    resp = ezstepper_write(ser, address, &#39;?</span><span class="mi">8</span><span class="nv">R</span><span class="s s-Atom">\r\n&#39;)</span>

<span class="s s-Atom">    if not ezstepper_check_status(resp):</span>

<span class="s s-Atom">        logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">status</span> <span class="nn">bad</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">resp</span><span class="p">}.</span> <span class="nv">Is</span> <span class="nv">EZStepper</span><span class="o">/</span><span class="s s-Atom">encoder</span> <span class="s s-Atom">connected?&#39;)</span>

<span class="s s-Atom">        sys.exit(1)</span>

<span class="s s-Atom">    else:</span>

<span class="s s-Atom">        payload = resp[IDX_STATUS_BYTE+1:-NUM_TRAILING_BYTES]</span>

<span class="s s-Atom">        logger.debug(f&#39;</span><span class="nv">Encoder</span> <span class="nn">reading</span><span class="p">:</span> <span class="p">{</span><span class="s s-Atom">payload</span><span class="p">}</span><span class="s s-Atom">&#39;)</span>

<span class="s s-Atom">        if payload:</span>

<span class="s s-Atom">            ticks = int(payload.decode(&#39;utf</span><span class="o">-</span><span class="mi">8</span><span class="s s-Atom">&#39;))</span>

<span class="s s-Atom">        else:</span>

<span class="s s-Atom">            logger.critical(f&#39;</span><span class="nv">Encoder</span> <span class="p">{</span><span class="s s-Atom">address</span><span class="p">}</span> <span class="s s-Atom">didn\&#39;t respond.&#39;</span><span class="p">)</span>

            <span class="s s-Atom">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="s s-Atom">return</span> <span class="s s-Atom">ticks</span>
</code></pre></div>

</details>
<h3 id="look_for_response">look_for_response</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">look_for_response</span><span class="p">(</span>
    <span class="n">resp</span>
<span class="p">)</span>
</code></pre></div>

<p>Responses addressed to the controller node begin with /0, with possible</p>
<p>junk before.</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>None</td>
<td>bytes, EZStepper response, straight out of serial</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>resp</td>
<td>Any bytes after /0</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="nv">def</span> <span class="nv">look_for_response</span><span class="ss">(</span><span class="nv">resp</span><span class="ss">)</span>:

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="nv">Responses</span> <span class="nv">addressed</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">controller</span> <span class="nv">node</span> <span class="nv">begin</span> <span class="nv">with</span> <span class="o">/</span><span class="mi">0</span>, <span class="nv">with</span> <span class="nv">possible</span>

    <span class="nv">junk</span> <span class="nv">before</span>.

    <span class="nv">Parameters</span>

    <span class="o">----------</span>

    <span class="nv">resp</span>

        <span class="nv">bytes</span>, <span class="nv">EZStepper</span> <span class="nv">response</span>, <span class="nv">straight</span> <span class="nv">out</span> <span class="nv">of</span> <span class="nv">serial</span>

    <span class="nv">Returns</span>

    <span class="o">-------</span>

    <span class="nv">resp</span>

        <span class="nv">Any</span> <span class="nv">bytes</span> <span class="nv">after</span> <span class="o">/</span><span class="mi">0</span>

    <span class="s1">&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nv">b</span><span class="s1">&#39;</span><span class="s">/0</span><span class="s1">&#39;</span> <span class="nv">in</span> <span class="nv">resp</span>:

        <span class="nv">resp</span> <span class="o">=</span> <span class="nv">resp</span>[<span class="nv">resp</span>.<span class="nv">find</span><span class="ss">(</span><span class="nv">b</span><span class="s1">&#39;</span><span class="s">/0</span><span class="s1">&#39;</span><span class="ss">)</span>:]

    <span class="k">else</span>:

        <span class="nv">resp</span> <span class="o">=</span> <span class="nv">b</span><span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="nv">resp</span>
</code></pre></div>

</details>
<h3 id="send_hawkeye_byte">send_hawkeye_byte</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">send_hawkeye_byte</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">:</span><span class="n">hotspot</span><span class="o">.</span><span class="n">hw_context</span><span class="o">.</span><span class="n">DummySerial</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">)</span>
</code></pre></div>

<p>Control three groups of Hawkeye IR sources on the raft. Each of the first</p>
<p>three bits of the <code>data</code> byte turns on one of the three available groups of
Hawkeyes on the raft: center, inner ring, and outer ring.
The byte is sent over serial to a microcontroller, which forwards the byte
to a shift register on the raft via SPI.</p>
<p>For example:
- data = 1 -&gt; 001 -&gt; center Hawkeye only
- data = 2 -&gt; 010 -&gt; inner ring only
- data = 3 -&gt; 011 -&gt; center and inner
- data = 7 -&gt; 111 -&gt; center, inner, outer</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send byte over from</td>
<td>None</td>
</tr>
<tr>
<td>data (int)</td>
<td>None</td>
<td>integer whose binary representation will appear at the shift register</td>
<td></td>
</tr>
<tr>
<td>outputs on the raft</td>
<td>None</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">send_hawkeye_byte</span><span class="p">(</span><span class="n">ser</span><span class="o">:</span> <span class="n">HawkeyeSerial</span><span class="p">,</span> <span class="k">data</span><span class="p">)</span><span class="o">:</span>

    <span class="s1">&#39;</span><span class="se">&#39;&#39;</span><span class="s1"></span>

<span class="s1">    Control three groups of Hawkeye IR sources on the raft. Each of the first</span>

<span class="s1">    three bits of the `data` byte turns on one of the three available groups of</span>

<span class="s1">    Hawkeyes on the raft: center, inner ring, and outer ring.</span>

<span class="s1">    The byte is sent over serial to a microcontroller, which forwards the byte</span>

<span class="s1">    to a shift register on the raft via SPI.</span>

<span class="s1">    For example:</span>

<span class="s1">    - data = 1 -&gt; 001 -&gt; center Hawkeye only</span>

<span class="s1">    - data = 2 -&gt; 010 -&gt; inner ring only</span>

<span class="s1">    - data = 3 -&gt; 011 -&gt; center and inner</span>

<span class="s1">    - data = 7 -&gt; 111 -&gt; center, inner, outer</span>

<span class="s1">    Parameters</span>

<span class="s1">    ----------</span>

<span class="s1">    ser</span>

<span class="s1">        pyserial instance, the port to send byte over from</span>

<span class="s1">    data (int)</span>

<span class="s1">        integer whose binary representation will appear at the shift register</span>

<span class="s1">        outputs on the raft</span>

<span class="s1">    </span><span class="se">&#39;&#39;</span><span class="s1">&#39;</span>

    <span class="n">assert</span> <span class="n">isinstance</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">data</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="o">:</span>

        <span class="k">data</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="k">if</span> <span class="k">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">:</span>

        <span class="k">data</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ser</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{data}</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">return</span>
</code></pre></div>

</details>
<h3 id="wait_for_ready">wait_for_ready</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">wait_for_ready</span><span class="p">(</span>
    <span class="n">ser</span><span class="p">,</span>
    <span class="n">address</span><span class="p">,</span>
    <span class="n">ready_timeout</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>ser</td>
<td>None</td>
<td>pyserial instance, the port to send bytes over from</td>
<td>None</td>
</tr>
<tr>
<td>address</td>
<td>None</td>
<td>str, address of ezstepper</td>
<td>None</td>
</tr>
<tr>
<td>ready_timeout (optional)</td>
<td>None</td>
<td>float, time in seconds before deciding the stepper is unresponsive</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">wait_for_ready</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ready_timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    Parameters</span>

<span class="sd">    ----------</span>

<span class="sd">    ser</span>

<span class="sd">        pyserial instance, the port to send bytes over from</span>

<span class="sd">    address</span>

<span class="sd">        str, address of ezstepper</span>

<span class="sd">    ready_timeout (optional)</span>

<span class="sd">        float, time in seconds before deciding the stepper is unresponsive</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="o">!=</span> <span class="n">address</span><span class="p">:</span>

        <span class="c1"># only send a new command if ezstepper not busy</span>

        <span class="n">start_busywait</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">ready</span> <span class="o">=</span> <span class="n">False</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">ready</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_busywait</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ready_timeout</span><span class="p">:</span>

            <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="n">f</span><span class="s1">&#39;/{address}Q</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">look_for_response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>

                <span class="n">ready</span> <span class="o">=</span> <span class="n">ezstepper_check_ready</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Waited {time.time() - start_busywait:.2f} sec for ready signal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;EZStepper {address} was not ready in allotted time {ready_timeout} sec&#39;</span><span class="p">)</span>

    <span class="k">return</span>
</code></pre></div>

</details>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../executive/" title="Executive" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Executive
              </span>
            </div>
          </a>
        
        
          <a href="../hw_context/" title="Hw Context" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Hw Context
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>